name: Deploy to Fly Demo

on:
    workflow_run:
        workflows: ['Build and Publish Docker Images Demo']
        branches: [develop, temp]
        types:
            - completed
env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy API
        uses: superfly/flyctl-actions@master
        with:
          args: deploy --config ./.fly/applications/api/fly.toml --image ${{ steps.build.outputs.image }}
          
      - name: Build image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./.deploy/api/Dockerfile
          tags: ${{ steps.prep.outputs.tagged_image }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,mode=max,dest=/tmp/.buildx-cache-new
          
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
          
      - name: Deploy Webapp
        uses: superfly/flyctl-actions@master
        with:
          args: deploy --config ./.fly/applications/webapp/fly.toml --image ${{ steps.build.outputs.image }}
          
      - name: Build image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./.deploy/api/Dockerfile
          tags: ${{ steps.prep.outputs.tagged_image }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,mode=max,dest=/tmp/.buildx-cache-new
          
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache          
