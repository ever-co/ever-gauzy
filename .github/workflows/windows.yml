name: Desktop Build Windows Fixing

on:
  push:
    branches: [develop, temp]

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  release-windows:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [warp-windows-latest-x64-16x]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.1
          cache: 'yarn'

      # ✅ Ensure VS build toolchain exists (MSVC + MSBuild + SDK)
      - name: Install Visual Studio 2022 Build Tools (C++/MSBuild)
        shell: powershell
        run: |
          choco install -y visualstudio2022buildtools --package-parameters "--passive --norestart --wait"
          choco install -y visualstudio2022-workload-vctools --package-parameters "--passive --norestart --wait"
          choco install -y windows-sdk-10.0 --package-parameters "--passive --norestart --wait"

      # ✅ Help node-gyp pick VS 2022 explicitly
      - name: Configure node-gyp to use VS 2022
        shell: powershell
        run: |
          "GYP_MSVS_VERSION=2022" | Out-File -FilePath $env:GITHUB_ENV -Append
          "npm_config_msvs_version=2022" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Fix node-gyp and Python
        run: python3 -m pip install packaging setuptools

      - name: Install latest version of NPM
        run: 'npm install -g npm@9'

      - name: Install node-gyp package
        run: 'npm install --quiet -g node-gyp@10.2.0'

      - name: Install Yarn dependencies
        run: 'yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts'

      - name: Run Postinstall Manually
        run: 'yarn postinstall.manual'

      - name: Bump version desktop timer app
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.scripts/bump-version-electron.js')
            console.log(script.desktopTimer(false))
        env:
          PROJECT_REPO: 'https://github.com/ever-co/ever-gauzy.git'
          DESKTOP_TIMER_APP_NAME: 'ever-gauzy-desktop-timer'
          COMPANY_SITE_LINK: 'https://gauzy.co'
          DESKTOP_TIMER_APP_DESCRIPTION: 'Ever Gauzy Desktop Timer'
          DESKTOP_TIMER_APP_ID: 'com.ever.gauzydesktoptimer'

      - name: Print environment variables and their sizes
        shell: powershell
        run: |
          foreach ($envVar in [System.Environment]::GetEnvironmentVariables().Keys) {
            $value = [System.Environment]::GetEnvironmentVariable($envVar)

            if ($null -ne $value) {
              $length = $value.Length
              Write-Output "${envVar}: ${length}"
            }
          }

      - name: Print PATH var value
        shell: powershell
        run: |
          $path = [System.Environment]::GetEnvironmentVariable('PATH')
          Write-Output "PATH environment variable is:"
          Write-Output $path

      - name: Build Desktop Timer App
        run: |
          # We need to clear some environment variables to avoid the error about the limit of env vars size
          set AZURE_CONFIG_DIR=
          set AZURE_DEVOPS_CACHE_DIR=
          set AZURE_EXTENSION_DIR=
          set STATS_BLT=
          set STATS_D=
          set STATS_D_D=
          set STATS_EXT=
          set STATS_EXTP=
          set STATS_RDCL=
          set STATS_TIS=
          set STATS_TRP=
          set STATS_UE=
          set STATS_V3PS=
          set STATS_VMD=
          set STATS_VMFE=
          set ANDROID_HOME=
          set ANDROID_NDK=
          set ANDROID_NDK_HOME=
          set ANDROID_NDK_LATEST_HOME=
          set ANDROID_NDK_ROOT=
          set ANDROID_SDK_ROOT=
          set GOROOT_1_20_X64=
          set GOROOT_1_21_X64=
          set GOROOT_1_22_X64=
          set GRADLE_HOME=
          set JAVA_HOME=
          set JAVA_HOME_11_X64=
          set JAVA_HOME_17_X64=
          set JAVA_HOME_21_X64=
          set JAVA_HOME_8_X64=
          set PGBIN=
          set PGDATA=
          set PGPASSWORD=
          set PGROOT=
          set PGUSER=
          set PHPROOT=
          set WARPBUILD_GH_JIT_TOKEN=
          set npm_package_scripts_build_package_plugins_post_docker=
          set npm_package_scripts_build_package_plugins_post_prod=
          set npm_package_scripts_build_package_plugins_post=
          set npm_package_scripts_build_package_all_docker=
          set npm_package_scripts_build_package_all_prod=
          set npm_package_scripts_build_package_plugins_pre_docker=
          set npm_package_scripts_build_package_plugins_pre_prod=
          set npm_package_scripts_build_package_all=
          set npm_package_scripts_build_package_plugins_pre=
          set npm_package_scripts_build_desktop=
          set npm_package_scripts_build_desktop_timer=
          set npm_package_scripts_build_gauzy_server=
          set npm_package_scripts_build_gauzy_api_server=
          set npm_package_scripts_build_gauzy_mcp_server=
          set npm_package_scripts_build_package_gauzy_docker=
          set npm_package_scripts_build_package_gauzy_prod=
          set npm_package_scripts_build_integration_ui_plugins_docker=
          set npm_package_scripts_build_package_api_docker=
          set npm_package_scripts_build_integration_ui_plugins_prod=
          set npm_package_scripts_build_package_api=
          set npm_package_scripts_build_package_api_prod=
          set npm_package_scripts_build_package_gauzy=
          set npm_package_scripts_build_gauzy_server_linux_release_gh=
          set npm_package_scripts_build_gauzy_server_linux_release=
          set npm_package_scripts_build_gauzy_api_server_linux_release=
          set npm_package_scripts_build_gauzy_api_server_linux_release_gh=
          set npm_package_scripts_build_gauzy_mcp_server_linux_release_gh=
          set npm_package_scripts_build_gauzy_mcp_server_linux_release=
          set npm_package_scripts_build_gauzy_mcp_server_linux=
          set npm_package_scripts_build_gauzy_api_server_linux=
          set npm_package_scripts_build_gauzy_server_linux=
          set npm_package_scripts_build_gauzy_mcp_server_windows_release_gh=
          set npm_package_scripts_build_gauzy_mcp_server_windows_release=
          set npm_package_scripts_build_gauzy_api_server_windows_release_gh=
          set npm_package_scripts_build_gauzy_api_server_windows_release=
          set npm_package_scripts_build_gauzy_server_windows_release_gh=
          set npm_package_scripts_build_gauzy_server_windows_release=
          set npm_package_scripts_build_gauzy_api_server_windows=
          set npm_package_scripts_build_gauzy_mcp_server_windows=
          set npm_package_scripts_build_gauzy_server_windows=
          set npm_package_scripts_build_gauzy_api_server_linux_release_gh=
          yarn build:desktop-timer:windows:release:gh
        env:
          USE_HARD_LINKS: false
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          EP_GH_IGNORE_TIME: true
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_TRACES_SAMPLE_RATE: '${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}'
          SENTRY_PROFILE_SAMPLE_RATE: '${{ secrets.SENTRY_PROFILE_SAMPLE_RATE }}'
          SENTRY_HTTP_TRACING_ENABLED: '${{ secrets.SENTRY_HTTP_TRACING_ENABLED }}'
          SENTRY_POSTGRES_TRACKING_ENABLED: '${{ secrets.SENTRY_POSTGRES_TRACKING_ENABLED }}'
          SENTRY_PROFILING_ENABLED: '${{ secrets.SENTRY_PROFILING_ENABLED }}'
          DO_KEY_ID: ${{ secrets.DO_KEY_ID }}
          DO_SECRET_KEY: ${{ secrets.DO_SECRET_KEY }}
          NX_NO_CLOUD: true
          PATH: 'C:\hostedtoolcache\windows\node\20.18.1\x64;C:\npm\prefix;C:\Program Files\Git\cmd;C:\Program Files\Git\usr\bin;C:\hostedtoolcache\windows\Python\3.9.13\x64\Scripts;C:\hostedtoolcache\windows\Python\3.9.13\x64;C:\ProgramData\Chocolatey\bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Windows\System32\OpenSSH\;C:\Program Files\PowerShell\7\;C:\Program Files (x86)\NSIS\;C:\Program Files (x86)\WiX Toolset v3.14\bin;C:\Program Files\CMake\bin;C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps'
