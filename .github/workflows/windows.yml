name: Desktop Build Windows Fixing

on:
  push:
    branches: [develop, temp]

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  release-windows:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [warp-windows-latest-x64-16x]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v4
        with:
          node-version: 22.21.1
          cache: 'yarn'

      - name: Install Visual Studio 2022 Build Tools (VCTools)
        shell: powershell
        run: |
          choco install -y visualstudio2022buildtools --execution-timeout=21600 --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --includeOptional --passive --norestart"

      # âœ… Help node-gyp pick VS 2022 explicitly
      - name: Configure node-gyp to use VS 2022
        shell: powershell
        run: |
          "GYP_MSVS_VERSION=2022" | Out-File -FilePath $env:GITHUB_ENV -Append
          "npm_config_msvs_version=2022" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Fix node-gyp and Python
        run: python3 -m pip install packaging setuptools

      - name: Setup MSVC (VS 2022 dev env)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install latest version of NPM
        run: 'npm install -g npm@10.9.4'

      - name: Install globally node-gyp, ts-node and nx packages
        run: 'npm install --quiet -g node-gyp@10.2.0 ts-node@10.9.2 nx@20.8.0'

      - name: Configure npm python for node-gyp
        shell: powershell
        run: |
          $py = (Get-Command python.exe).Source
          Write-Host "python is: $py"
          "npm_config_python=$py" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PYTHON=$py"            | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Show tool versions
        shell: powershell
        run: |
          node -v
          npm -v
          python --version
          python -c "import sys; print(sys.executable)"

      - name: Install Yarn dependencies
        run: 'yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts'

      - name: Run Postinstall Manually
        run: 'yarn postinstall.manual'

      - name: Bump version desktop timer app
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.scripts/bump-version-electron.js')
            console.log(script.desktopTimer(false))
        env:
          PROJECT_REPO: 'https://github.com/ever-co/ever-gauzy.git'
          DESKTOP_TIMER_APP_NAME: 'ever-gauzy-desktop-timer'
          COMPANY_SITE_LINK: 'https://gauzy.co'
          DESKTOP_TIMER_APP_DESCRIPTION: 'Ever Gauzy Desktop Timer'
          DESKTOP_TIMER_APP_ID: 'com.ever.gauzydesktoptimer'

      - name: Print environment variables and their sizes
        shell: powershell
        run: |
          foreach ($envVar in [System.Environment]::GetEnvironmentVariables().Keys) {
            $value = [System.Environment]::GetEnvironmentVariable($envVar)

            if ($null -ne $value) {
              $length = $value.Length
              Write-Output "${envVar}: ${length}"
            }
          }

      - name: Print PATH var value
        shell: powershell
        run: |
          $path = [System.Environment]::GetEnvironmentVariable('PATH')
          Write-Output "PATH environment variable is:"
          Write-Output $path

      - name: Add Yarn/Node/npm-global/node_modules to GITHUB_PATH
        shell: powershell
        run: |
          # Get yarn and node directories
          $yarnPath = (Get-Command yarn).Source | Split-Path -Parent
          $nodePath = (Get-Command node).Source | Split-Path -Parent

          # Get npm global prefix (where global packages are installed)
          $npmGlobalBin = npm config get prefix

          # Get the workspace's node_modules/.bin for local binaries (cross-env, ts-node, etc.)
          $localBin = Join-Path $PWD "node_modules\.bin"

          # Add all paths to GITHUB_PATH for subprocess inheritance
          echo $localBin >> $env:GITHUB_PATH
          echo $npmGlobalBin >> $env:GITHUB_PATH
          echo $yarnPath >> $env:GITHUB_PATH
          if ($nodePath -ne $yarnPath) {
            echo $nodePath >> $env:GITHUB_PATH
          }

          Write-Host "Added to GITHUB_PATH:"
          Write-Host "  Local bin: $localBin"
          Write-Host "  npm global: $npmGlobalBin"
          Write-Host "  Yarn path: $yarnPath"
          Write-Host "  Node path: $nodePath"

          # Verify the binaries exist
          Write-Host ""
          Write-Host "Checking local binaries:"
          if (Test-Path "$localBin\cross-env.cmd") { Write-Host "  cross-env: found" } else { Write-Host "  cross-env: NOT FOUND" }
          if (Test-Path "$localBin\ts-node.cmd") { Write-Host "  ts-node: found" } else { Write-Host "  ts-node: NOT FOUND" }
          if (Test-Path "$localBin\nx.cmd") { Write-Host "  nx: found" } else { Write-Host "  nx: NOT FOUND" }

      - name: Build Desktop Timer App
        shell: powershell
        run: |
          # Print PATH for debugging
          Write-Host "=== Current PATH ==="
          $env:PATH -split ';' | ForEach-Object { Write-Host "  $_" }
          Write-Host ""
          Write-Host "=== Command locations ==="
          Write-Host "Node: $((Get-Command node -ErrorAction SilentlyContinue).Source)"
          Write-Host "Yarn: $((Get-Command yarn -ErrorAction SilentlyContinue).Source)"
          Write-Host "npx: $((Get-Command npx -ErrorAction SilentlyContinue).Source)"
          Write-Host "ts-node: $((Get-Command ts-node -ErrorAction SilentlyContinue).Source)"
          Write-Host "cross-env: $((Get-Command cross-env -ErrorAction SilentlyContinue).Source)"
          Write-Host "nx: $((Get-Command nx -ErrorAction SilentlyContinue).Source)"
          Write-Host ""
          Write-Host "=== Starting build ==="
          # Run the build
          yarn build:desktop-timer:windows:release:gh
        env:
          USE_HARD_LINKS: false
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          EP_GH_IGNORE_TIME: true
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_TRACES_SAMPLE_RATE: '${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}'
          SENTRY_PROFILE_SAMPLE_RATE: '${{ secrets.SENTRY_PROFILE_SAMPLE_RATE }}'
          SENTRY_HTTP_TRACING_ENABLED: '${{ secrets.SENTRY_HTTP_TRACING_ENABLED }}'
          SENTRY_POSTGRES_TRACKING_ENABLED: '${{ secrets.SENTRY_POSTGRES_TRACKING_ENABLED }}'
          SENTRY_PROFILING_ENABLED: '${{ secrets.SENTRY_PROFILING_ENABLED }}'
          DO_KEY_ID: ${{ secrets.DO_KEY_ID }}
          DO_SECRET_KEY: ${{ secrets.DO_SECRET_KEY }}
          NX_NO_CLOUD: true
