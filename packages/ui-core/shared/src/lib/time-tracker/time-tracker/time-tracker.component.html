<ng-template [ngIf]="isOpen">
	<nb-card
		class="timer-card card"
		[ngStyle]="{ 'padding-bottom': isExpanded ? '' : '0px' }"
		[ngClass]="
			theme === 'default' || theme === 'corporate' || theme === 'gauzy-light'
				? 'background-basic-color-1'
				: 'background-basic-color-2'
		"
		[style.transform]="'matrix(1, 0, 0, 1,' + this.position.x + ', ' + this.position.y + ')'"
		ngxDraggableDom="true"
		(stopped)="draggablePosition($event)"
	>
		<nb-card-body>
			<div class="header">
				<button *ngIf="!isExpanded" nbButton ghost size="small" (click)="isExpanded = true">
					<nb-icon icon="expand-outline"></nb-icon>
				</button>
				<button
					*ngIf="isExpanded"
					nbButton
					ghost
					size="small"
					(click)="$event.stopPropagation(); setTimeType(timeLogType.TRACKED); isExpanded = false"
				>
					<nb-icon icon="minus-outline"></nb-icon>
				</button>
				<button class="btn-close" size="small" nbButton ghost (click)="toggleWindow()">
					<nb-icon icon="close-outline"></nb-icon>
				</button>
			</div>
			<form #form="ngForm">
				<div [ngStyle]="{ margin: isExpanded ? '' : '0px' }" class="timer-container form-group">
					<ng-template [ngIf]="(trackType$ | async) == timeLogType.TRACKED">
						<div class="timer">
							<h6 *ngIf="isExpanded">
								{{ 'TIMER_TRACKER.TIMER' | translate }}
							</h6>
							<div class="row">
								<div class="col">
									<div class="time-tracker">
										<div class="is_billable">
											<button
												nbButton
												type="button"
												(click)="$event.stopPropagation(); isBillable = !isBillable"
												size="small"
												[status]="isBillable ? 'primary' : 'basic'"
												[nbTooltip]="'TIMER_TRACKER.IS_BILLABLE' | translate"
												[disabled]="running"
											>
												$
											</button>
										</div>
										<div class="time-count">
											<span class="current-session">
												{{ currentSessionTime }}
											</span>
											<span class="today-time mt-2">
												{{ 'TIMER_TRACKER.TODAY' | translate }}
												{{ todaySessionTime }}
											</span>
											<span *ngIf="limitReached" class="today-time mt-2 invalid-feedback d-block">
												{{ 'TOASTR.TITLE.MAX_LIMIT_REACHED' | translate }}
											</span>
											<ga-time-tracker-status class="status"></ga-time-tracker-status>
										</div>
										<div class="actions">
											<div class="toggle">
												<button
													nbButton
													type="submit"
													[status]="running ? 'danger' : 'success'"
													[ngClass]="running ? '' : 'button success'"
													shape="round"
													[nbTooltip]="
														(running
															? 'TIMER_TRACKER.STOP_TIMER'
															: 'TIMER_TRACKER.START_TIMER'
														) | translate
													"
													(click)="toggleTimer(true)"
													[disabled]="isDisable || limitReached || form.invalid"
												>
													<fa-icon [icon]="!running ? play : pause"></fa-icon>
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</ng-template>
				</div>
				<div *ngIf="isExpanded && !running">
					<div class="form-group">
						<label
							for="projectId"
							[ngClass]="projectInput?.errors?.required ? 'required-asterisk' : null"
							>{{ 'TIMER_TRACKER.SELECT_PROJECT' | translate }}</label
						>
						<ga-project-selector
							name="projectId"
							[skipGlobalChange]="true"
							[showAllOption]="false"
							[placeholder]="'TIMER_TRACKER.SELECT_PROJECT' | translate"
							[defaultSelected]="false"
							[organizationContactId]="organizationContactId"
							[employeeId]="employee?.id"
							[disabled]="running"
							[(ngModel)]="projectId"
							#projectInput="ngModel"
							[required]="organization?.requireProject"
						></ga-project-selector>
						<div
							*ngIf="projectInput?.errors?.required && projectInput?.touched"
							class="invalid-feedback d-block"
						>
							{{ 'TIMER_TRACKER.VALIDATION.PROJECT_REQUIRED' | translate }}
						</div>
					</div>

					<div class="form-group">
						<label for="taskId" [ngClass]="taskInput?.errors?.required ? 'required-asterisk' : null">
							{{ 'TIMER_TRACKER.SELECT_TASK' | translate }}
						</label>
						<ga-task-selector
							name="taskId"
							[projectId]="projectId"
							[employeeId]="employee?.id"
							[disabled]="running"
							[(ngModel)]="taskId"
							#taskInput="ngModel"
							[required]="organization?.requireTask"
						></ga-task-selector>
						<div *ngIf="taskInput?.errors?.required && taskInput?.touched" class="invalid-feedback d-block">
							{{ 'TIMER_TRACKER.VALIDATION.TASK_REQUIRED' | translate }}
						</div>
					</div>
					<div class="form-group custom">
						<label
							for="description"
							[ngClass]="descriptionInput?.errors?.required ? 'required-asterisk' : null"
						>
							{{ 'TIMER_TRACKER.DESCRIPTION' | translate }}
						</label>
						<textarea
							class="form-control"
							rows="2"
							fullWidth
							[placeholder]="'TIMER_TRACKER.DESCRIPTION' | translate"
							name="description"
							[disabled]="running"
							[(ngModel)]="description"
							#descriptionInput="ngModel"
							[required]="organization?.requireDescription"
						></textarea>
						<div
							*ngIf="descriptionInput?.errors?.required && descriptionInput?.touched"
							class="invalid-feedback d-block"
						>
							{{ 'TIMER_TRACKER.VALIDATION.DESCRIPTION_REQUIRED' | translate }}
						</div>
					</div>
					<div class="view-log-button mt-2" *ngIf="user?.employee?.id">
						<div *ngIf="(trackType$ | async) == timeLogType.TRACKED">
							<button
								nbButton
								status="success"
								[ngClass]="running ? 'button disabled' : 'button success start'"
								size="medium"
								[disabled]="running || isDisable || limitReached || form.invalid"
								(click)="toggleTimer(true)"
							>
								{{ 'TIMER_TRACKER.START_TIMER' | translate }}
							</button>
						</div>
						<a
							nbButton
							ghost
							outline
							class="button timesheet"
							[routerLink]="['/pages/employees/timesheets']"
							size="medium"
						>
							{{ 'TIMER_TRACKER.VIEW_TIMESHEET' | translate }}
						</a>
					</div>
				</div>
			</form>
		</nb-card-body>
		<nb-card-footer [ngStyle]="{ visibility: hideAlert ? 'hidden' : 'visible' }">
			<nb-alert (close)="hideAlert = true" status="primary" class="alert" closable>
				<nb-icon size="tiny" icon="info-outline"></nb-icon>
				<div
					[innerHTML]="
						'TIMER_TRACKER.ALERT_DESKTOP_DOWNLOAD'
							| translate : { downloadURL: PLATFORM_WEBSITE_DOWNLOAD_URL }
					"
				></div>
			</nb-alert>
		</nb-card-footer>
	</nb-card>
</ng-template>
