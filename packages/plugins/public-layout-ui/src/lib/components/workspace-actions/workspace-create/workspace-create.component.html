<section class="login-container">
	<div class="login-wrapper">
		<!-- Step 1: Email and Code Input -->
		<ng-container *ngIf="!showWorkspaceSelection && !showCreationStep && !showAccountCreation">
			<div class="svg-wrapper">
				<ngx-gauzy-logo [isAccordion]="false" class="ever-logo-svg"></ngx-gauzy-logo>
				<button nbButton ghost size="small" (click)="closeWindow()" class="close-button">
					<nb-icon icon="close-outline"></nb-icon>
				</button>
			</div>
			<div class="headings">
				<div class="headings-inner">
					<h2 id="title" class="title">{{ 'WORKSPACES.CREATE.TITLE' | translate }}</h2>
					<p class="sub-title">{{ 'WORKSPACES.CREATE.SUBTITLE' | translate }}</p>
				</div>
				<ng-template [ngIf]="isCodeSent">
					<div class="sent-code-container">
						<p
							[ngClass]="{
								'normal-text': email?.value.length < 30,
								'minimum-text': email?.value.length >= 30
							}"
						>
							{{ 'WORKSPACES.CREATE.SUCCESS_SENT_CODE_TITLE' | translate }}
							<b class="title">{{ email?.value }}</b>
							<br />
							<span>{{ 'WORKSPACES.CREATE.SUCCESS_SENT_CODE_SUB_TITLE' | translate }}</span>
						</p>
					</div>
				</ng-template>
			</div>
			<div class="hr-div-strong"></div>

			<form #formDirective="ngForm" [formGroup]="form" (ngSubmit)="confirmSignInCode()">
				<!-- Email input -->
				<div class="form-control-group">
					<label class="label" for="input-email">{{ 'LOGIN_PAGE.LABELS.EMAIL' | translate }}</label>
					<nb-form-field>
						<input
							name="input-email"
							id="input-email"
							nbInput
							fullWidth
							formControlName="email"
							[placeholder]="'LOGIN_PAGE.PLACEHOLDERS.EMAIL' | translate"
							[status]="email.dirty ? (email.invalid ? 'danger' : 'success') : 'basic'"
							[attr.aria-invalid]="email.invalid && email.touched ? true : null"
							autofocus
							autocomplete-off
							[ngClass]="isCodeSent ? 'not-allowed' : ''"
						/>
						<nb-icon
							class="edit-email"
							*ngIf="isCodeSent"
							nbSuffix
							nbButton
							size="small"
							ghost
							icon="edit-outline"
							nbTooltip="edit email"
							nbTooltipPosition="top"
						></nb-icon>
					</nb-form-field>
					<ng-container *ngIf="email.invalid && email.touched && !email.pristine">
						<p class="caption status-danger" *ngIf="email?.errors?.required">
							{{ 'LOGIN_PAGE.VALIDATION.EMAIL_REQUIRED' | translate }}
						</p>
						<p class="caption status-danger" *ngIf="email?.errors?.pattern">
							{{ 'LOGIN_PAGE.VALIDATION.EMAIL_REAL_REQUIRED' | translate }}
						</p>
					</ng-container>
				</div>
				<!-- Code input -->
				<ng-container *ngIf="isCodeSent">
					<div class="form-control-group">
						<label class="label" for="input-code">{{ 'LOGIN_PAGE.LABELS.CODE' | translate }}</label>
						<input
							name="input-code"
							id="input-code"
							nbInput
							fullWidth
							formControlName="code"
							[placeholder]="'LOGIN_PAGE.PLACEHOLDERS.CODE' | translate"
							[status]="code.dirty ? (code.invalid ? 'danger' : 'success') : 'basic'"
							[attr.aria-invalid]="code.invalid && code.touched ? true : null"
							maxlength="6"
							autofocus
							autocomplete-off
						/>
						<ng-container *ngIf="code.invalid && code.touched">
							<p class="caption status-danger" *ngIf="code.errors?.required">
								{{ 'LOGIN_PAGE.VALIDATION.CODE_REQUIRED' | translate }}
							</p>
							<p class="caption status-danger" *ngIf="code.errors?.minlength">
								{{
									'LOGIN_PAGE.VALIDATION.CODE_REQUIRED_LENGTH'
										| translate : { requiredLength: code.errors?.minlength?.requiredLength }
								}}
							</p>
						</ng-container>
						<!-- Resend Code Button & Text -->
						<ng-template [ngIf]="isCodeSent">
							<p class="new-code-wrapper">
								<ng-template [ngIf]="isCodeResent" [ngIfElse]="resendButton">
									<span class="request-new-code">
										{{
											'LOGIN_PAGE.LOGIN_MAGIC.REQUEST_NEW_CODE_TITLE'
												| translate : { countdown: countdown }
										}}
									</span>
								</ng-template>

								<ng-template #resendButton>
									<a class="resend-code" (click)="onResendCode()">
										{{ 'LOGIN_PAGE.LOGIN_MAGIC.RESEND_CODE_TITLE' | translate }}
									</a>
								</ng-template>
							</p>
						</ng-template>
					</div>
				</ng-container>
				<!-- Submit Button -->
				<div class="submit-btn-wrapper">
					<a class="forgot-email caption-2 forgot-email-big" href="mailto:forgot@gauzy.co">
						{{ 'LOGIN_PAGE.FORGOT_EMAIL_TITLE' | translate }}
					</a>
					<div class="submit-inner-wrapper">
						<ng-template [ngIf]="isCodeSent" [ngIfElse]="sendCodeButtonTemplate">
							<button
								type="submit"
								nbButton
								size="tiny"
								class="submit-btn"
								[disabled]="form.invalid || isLoading"
							>
								<span class="btn-text">
									{{ 'BUTTONS.CONTINUE' | translate }}
								</span>
								<ng-template [ngIf]="isLoading">
									<nb-icon
										class="btn-icon"
										[ngClass]="isLoading ? 'spinner' : ''"
										icon="loader-outline"
									></nb-icon>
								</ng-template>
							</button>
						</ng-template>
						<ng-template #sendCodeButtonTemplate>
							<button
								type="button"
								nbButton
								size="tiny"
								class="submit-btn"
								[disabled]="email.invalid || isLoading"
								(click)="sendLoginCode()"
							>
								<span class="btn-text">
									{{ 'BUTTONS.SEND_CODE' | translate }}
								</span>
								<ng-template [ngIf]="isLoading">
									<nb-icon
										class="btn-icon"
										[ngClass]="isLoading ? 'spinner' : ''"
										icon="loader-outline"
									></nb-icon>
								</ng-template>
							</button>
						</ng-template>
					</div>
				</div>
				<div class="magic-description">
					{{ 'LOGIN_PAGE.LOGIN_MAGIC.DESCRIPTION_TITLE' | translate }}
				</div>
			</form>
		</ng-container>

		<!-- Step 2: Workspace Selection -->
		<ng-container *ngIf="showWorkspaceSelection">
			<div class="svg-wrapper">
				<ngx-gauzy-logo [isAccordion]="false" class="ever-logo-svg"></ngx-gauzy-logo>
				<button nbButton ghost size="small" (click)="closeWindow()" class="close-button">
					<nb-icon icon="close-outline"></nb-icon>
				</button>
			</div>

			<div class="workspace-selection-content">
				<div class="headings">
					<div class="headings-inner">
						<h2 class="title">{{ 'WORKSPACES.SELECTION.WELCOME_BACK' | translate }}</h2>
						<p class="sub-title">
							{{ 'WORKSPACES.FIND.RESULTS_STEP.DESCRIPTION' | translate : { count: totalWorkspaces } }}
						</p>
					</div>
				</div>

				<div class="hr-div-strong"></div>

				<div class="workspace-list">
					<h3>
						{{ 'WORKSPACES.SELECTION.SELECT_WORKSPACE_FOR' | translate }}
						<span class="email">{{ confirmedEmail }}</span>
					</h3>

					<div class="workspace-items">
						<div
							*ngFor="let workspace of workspaces"
							class="workspace-item"
							(click)="signInWorkspace(workspace)"
						>
							<div class="workspace-image">
								<img
									[src]="workspace.user?.tenant?.logo || '/assets/images/logos/logo_Gauzy.png'"
									alt="Workspace Logo"
								/>
							</div>
							<div class="workspace-info">
								<div class="workspace-name">{{ workspace.user?.tenant?.name }}</div>
								<div class="workspace-email">{{ workspace.user?.email }}</div>
							</div>
							<nb-icon icon="arrow-forward-outline"></nb-icon>
						</div>
					</div>

					<div class="create-new-workspace">
						<button nbButton outline status="primary" (click)="continueToCreation()">
							<nb-icon icon="plus-outline"></nb-icon>
							{{ 'WORKSPACES.CREATE.CREATE_NEW_WORKSPACE' | translate }}
						</button>
					</div>
				</div>
			</div>
		</ng-container>

		<!-- Step 3: Account Creation -->
		<ng-container *ngIf="showAccountCreation">
			<div class="svg-wrapper">
				<ngx-gauzy-logo [isAccordion]="false" class="ever-logo-svg"></ngx-gauzy-logo>
				<button nbButton ghost size="small" (click)="closeWindow()" class="close-button">
					<nb-icon icon="close-outline"></nb-icon>
				</button>
			</div>

			<div class="creation-content">
				<div class="headings">
					<div class="headings-inner">
						<h2 class="title">{{ 'WORKSPACE_CREATE.ACCOUNT_CREATION.TITLE' | translate }}</h2>
						<p class="sub-title">{{ 'WORKSPACE_CREATE.ACCOUNT_CREATION.SUBTITLE' | translate }}</p>
					</div>
				</div>

				<div class="hr-div-strong"></div>

				<form [formGroup]="accountForm" (ngSubmit)="continueToWorkspaceCreation()">
					<div class="form-group">
						<label for="firstName">{{ 'FORM.LABELS.FIRST_NAME' | translate }}</label>
						<input
							nbInput
							fullWidth
							id="firstName"
							formControlName="firstName"
							[placeholder]="'FORM.PLACEHOLDERS.FIRST_NAME' | translate"
							[status]="firstName.invalid && firstName.touched ? 'danger' : 'basic'"
						/>
						<div *ngIf="firstName.invalid && firstName.touched" class="error-message">
							{{ 'FORM.VALIDATION.FIRST_NAME_REQUIRED' | translate }}
						</div>
					</div>

					<div class="form-group">
						<label for="lastName">{{ 'FORM.LABELS.LAST_NAME' | translate }}</label>
						<input
							nbInput
							fullWidth
							id="lastName"
							formControlName="lastName"
							[placeholder]="'FORM.PLACEHOLDERS.LAST_NAME' | translate"
							[status]="lastName.invalid && lastName.touched ? 'danger' : 'basic'"
						/>
						<div *ngIf="lastName.invalid && lastName.touched" class="error-message">
							{{ 'FORM.VALIDATION.LAST_NAME_REQUIRED' | translate }}
						</div>
					</div>

					<ngx-password-form-field
						id="password"
						[placeholder]="'FORM.PLACEHOLDERS.PASSWORD' | translate"
						[label]="'FORM.LABELS.PASSWORD' | translate"
						[ctrl]="password"
						[icon]="true"
					></ngx-password-form-field>

					<ngx-password-form-field
						id="confirmPassword"
						[placeholder]="'FORM.PLACEHOLDERS.CONFIRM_PASSWORD' | translate"
						[label]="'FORM.LABELS.CONFIRM_PASSWORD' | translate"
						[ctrl]="confirmPassword"
						[icon]="true"
					></ngx-password-form-field>

					<div *ngIf="accountForm.errors?.['mustMatch'] && confirmPassword.touched" class="error-message">
						{{ 'FORM.VALIDATION.PASSWORDS_NOT_MATCH' | translate }}
					</div>

					<div class="submit-btn-wrapper">
						<button
							nbButton
							size="small"
							class="submit-btn"
							[disabled]="accountForm.invalid || isLoading"
							[class.btn-pulse]="isLoading"
						>
							{{ 'WORKSPACE_CREATE.BUTTONS.CONTINUE_TO_WORKSPACE_SETUP' | translate }}
						</button>
					</div>
				</form>
			</div>
		</ng-container>

		<!-- Step 4: Workspace Creation -->
		<ng-container *ngIf="showCreationStep">
			<div class="svg-wrapper">
				<ngx-gauzy-logo [isAccordion]="false" class="ever-logo-svg"></ngx-gauzy-logo>
				<button nbButton ghost size="small" (click)="closeWindow()" class="close-button">
					<nb-icon icon="close-outline"></nb-icon>
				</button>
			</div>

			<div class="creation-content">
				<div class="headings">
					<div class="headings-inner">
						<h2 class="title">{{ 'WORKSPACE_CREATE.WORKSPACE_SETUP.TITLE' | translate }}</h2>
						<p class="sub-title">{{ 'WORKSPACE_CREATE.WORKSPACE_SETUP.SUBTITLE' | translate }}</p>
					</div>
				</div>

				<div class="hr-div-strong"></div>

				<ga-organizations-step-form
					[loading]="isLoading"
					[isOnboarding]="true"
					(createOrganization)="onboardUser($event)"
				></ga-organizations-step-form>
			</div>
		</ng-container>
	</div>
</section>
