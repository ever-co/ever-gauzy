<!-- Async bindings for plugin data and various states -->
@let plugin = plugin$ | async;
<!-- Get the current plugin details -->
@let currentPlugin = marketplaceQuery.plugin$ | async;
<!-- Is Selected-->
@let isSelected = currentPlugin?.id === plugin?.id;
<!-- Installed version -->
@let installedVersionId = installedVersionId$ | async;
<!-- Async binding for editing state -->
@let editing = marketplaceQuery.updating$(plugin?.id) | async;
<!-- Check if the plugin is selected and disabled state for toggles -->
@let installed = installationQuery.installed$(plugin?.id) | async;
<!-- Determine if the plugin is currently being installed or uninstalled -->
@let installing = installationQuery.installing$(plugin?.id) | async;
<!-- Determine if the plugin is currently being uninstalled -->
@let uninstalling = installationQuery.uninstalling$(plugin?.id) | async;
<!-- Deleting state for plugins -->
@let deleting = marketplaceQuery.deleting$(plugin?.id) | async;
<!-- Adding state for versions -->
@let adding = versionQuery.creating$(plugin?.id) | async;
<!-- Update needed state -->
@let needUpdate = installed && plugin.version.id !== installedVersionId;
<!-- Loading state -->
@let loading = marketplaceQuery.isLoading$ | async;
<!-- Disabled state combining various conditions -->
@let disabled = editing || installing || uninstalling || deleting || adding;
<!-- Selected version state -->
@let selectedVersion = versionQuery.version$ | async;
<!-- Uploading state -->
@let uploading = marketplaceQuery.uploading$(plugin?.id) | async;
<!-- Progress state -->
@let progress = marketplaceQuery.uploadProgress$(plugin?.id) | async;
<!-- Sources state -->
@let sources = this.sourceQuery.sources$ | async;
<!-- Selected source state -->
@let selectedSource = this.sourceQuery.source$ | async;
<!-- Creating source state -->
@let creatingSource = this.sourceQuery.creating$(plugin?.id) | async;
<!-- Get current subscription -->
@let subscription = currentSubscription$ | async;

<!-- Main template -->
<nb-card class="content-active first plugin-details-card">
	<nb-card-header class="d-flex align-items-center justify-content-between">
		<div class="d-flex align-items-center">
			<h5 class="mb-0">{{ plugin?.name || ('SM_TABLE.NO_DATA.LOADING' | translate) }}</h5>
			<div class="ml-3">
				<nb-badge
					*ngIf="plugin"
					[status]="getStatusBadgeStatus(plugin.status)"
					[text]="getStatusLabel(plugin.status)"
					class="mr-2 position-relative"
				></nb-badge>
				<!-- Subscription Status Badge -->
				<gauzy-subscription-status-badge
					*ngIf="subscription"
					[status]="subscription.status"
					class="mr-2"
				></gauzy-subscription-status-badge>
				<nb-badge
					*ngIf="plugin"
					[status]="getPluginTypeBadgeStatus(plugin.type)"
					[text]="getTypeLabel(plugin.type)"
					class="mr-2 position-relative"
				></nb-badge>
				<nb-badge
					*ngIf="plugin && !plugin.hasPlan"
					status="success"
					text="Free"
					class="position-relative"
				></nb-badge>
				<!-- Access Level Badge -->
				<nb-badge
					*ngIf="accessLevel$ | async as accessLevel"
					[status]="getAccessLevelBadgeStatus(accessLevel)"
					[text]="getAccessLevelLabel(accessLevel)"
					class="mr-2 position-relative"
				>
				</nb-badge>
			</div>
		</div>
		<button nbButton ghost size="small" (click)="navigateBack()">
			<nb-icon icon="close-outline"></nb-icon>
		</button>
	</nb-card-header>

	<nb-card-body>
		@if(loading) {
		<div class="d-flex justify-content-center py-5">
			<nb-spinner status="primary"></nb-spinner>
		</div>
		}@else if(!plugin) {
		<div class="no-data py-5">
			<ngx-no-data-message [message]="'SM_TABLE.NO_DATA.PLUGIN_MARKETPLACE' | translate"></ngx-no-data-message>
		</div>
		}@else {
		<div class="plugin-content">
			<!-- Quick Actions -->
			<div class="quick-actions">
				@if(installed) {
				<div class="d-flex align-items-center">
					<nb-icon icon="checkmark-circle-2-outline" status="success" class="mr-2"></nb-icon>
					<span class="text-success">{{ 'PLUGIN.DETAILS.INSTALLED' | translate }}</span>
				</div>
				@if(needUpdate) {
				<button
					nbButton
					status="basic"
					size="small"
					[disabled]="disabled"
					(click)="installUpdate()"
					class="ml-3 action primary"
				>
					<nb-icon *gauzySpinnerButton="installing && isSelected" icon="sync-outline" class="mr-1"></nb-icon>
					{{ 'BUTTONS.UPDATE' | translate }}
				</button>
				}
				<button
					nbButton
					status="basic"
					size="small"
					[disabled]="disabled"
					(click)="uninstallPlugin()"
					class="ml-2 action danger"
				>
					<nb-icon
						*gauzySpinnerButton="uninstalling && isSelected"
						status="danger"
						icon="slash-outline"
					></nb-icon>
					{{ 'BUTTONS.UNINSTALL' | translate }}
				</button>
				}@else {
				<!-- Install button with subscription check -->
				@if(plugin.hasPlan) { @if(hasAccess$ | async) {
				<!-- User has active subscription -->
				<button
					nbButton
					status="basic"
					size="small"
					class="action success"
					[disabled]="disabled"
					(click)="installPlugin()"
					[nbTooltip]="'PLUGIN.TOOLTIP.INSTALL_WITH_SUBSCRIPTION' | translate"
				>
					<nb-icon
						*gauzySpinnerButton="installing && isSelected"
						icon="cloud-download-outline"
						class="mr-1"
					></nb-icon>
					{{ 'BUTTONS.INSTALL' | translate }}
				</button>
				} @else {
				<!-- User needs to subscribe first -->
				<button
					nbButton
					status="basic"
					size="small"
					class="action warning"
					[disabled]="disabled"
					(click)="installPlugin()"
					[nbTooltip]="'PLUGIN.TOOLTIP.SUBSCRIBE_TO_INSTALL' | translate"
				>
					<nb-icon *gauzySpinnerButton="installing && isSelected" icon="lock-outline" class="mr-1"></nb-icon>
					{{ 'PLUGIN.BUTTONS.SUBSCRIBE_AND_INSTALL' | translate }}
				</button>
				} } @else {
				<!-- Free plugin - no subscription required -->
				<button
					nbButton
					status="basic"
					size="small"
					class="action success"
					[disabled]="disabled"
					(click)="installPlugin()"
					[nbTooltip]="'PLUGIN.TOOLTIP.INSTALL_FREE' | translate"
				>
					<nb-icon
						*gauzySpinnerButton="installing && isSelected"
						icon="cloud-download-outline"
						class="mr-1"
					></nb-icon>
					{{ 'BUTTONS.INSTALL' | translate }}
				</button>
				} }
			</div>

			<!-- Plugin Info Tabs with Lazy Loading -->
			<nb-route-tabset
				class="plugin-tabs"
				[tabs]="tabs$ | async"
				[activeLinkOptions]="{ exact: false }"
			></nb-route-tabset>
		</div>
		}
	</nb-card-body>

	<nb-card-footer class="d-flex justify-content-between">
		<button nbButton type="button" size="small" class="action secondary" status="basic" (click)="navigateBack()">
			<nb-icon icon="arrow-back-outline" class="mr-1"></nb-icon>
			{{ 'BUTTONS.BACK' | translate | titlecase }}
		</button>

		<div class="action-buttons">
			<!-- View Subscription Button (shown when plugin has subscription) -->
			@if(hasSubscription$ | async) {
			<button
				nbButton
				type="button"
				size="small"
				status="info"
				[disabled]="disabled"
				(click)="viewSubscriptionHierarchy()"
				class="mr-2 action"
				[nbTooltip]="'PLUGIN.BUTTONS.VIEW_SUBSCRIPTION' | translate"
			>
				<nb-icon icon="credit-card-outline" class="mr-1"></nb-icon>
				{{ 'PLUGIN.BUTTONS.VIEW_SUBSCRIPTION' | translate }}
			</button>
			}
			<!-- Assign Users Button (for users with canAssign permission) -->
			@if(canAssign$ | async) {
			<button
				nbButton
				type="button"
				size="small"
				status="info"
				[disabled]="disabled"
				(click)="showAssignUsersDialog()"
				class="mr-2 action"
			>
				<nb-icon icon="person-add-outline" class="mr-1"></nb-icon>
				{{ 'PLUGIN.BUTTONS.ASSIGN_USERS' | translate }}
			</button>
			} @if(isOwner) {
			<button
				nbButton
				type="button"
				size="small"
				status="basic"
				[disabled]="disabled"
				(click)="addVersion()"
				class="mr-2 action primary soft"
			>
				<nb-icon *gauzySpinnerButton="adding && isSelected" icon="plus-outline" class="mr-1"></nb-icon>
				{{ 'BUTTONS.ADD_VERSION' | translate }}
				@if(uploading && adding){
				<span> {{ progress | percent : '1.2-2' }} </span>
				}
			</button>

			<button
				nbButton
				type="button"
				status="basic"
				[disabled]="disabled"
				size="small"
				(click)="addSource()"
				class="mr-2 action info"
			>
				<nb-icon *gauzySpinnerButton="creatingSource && isSelected" icon="plus-outline" class="mr-1"></nb-icon>
				{{ 'BUTTONS.ADD_MORE_SOURCES' | translate }}
				@if(uploading && creatingSource){
				<span> {{ progress | percent : '1.2-2' }} </span>
				}
			</button>

			<button
				nbButton
				type="button"
				status="basic"
				[disabled]="disabled"
				size="small"
				(click)="navigateToEdit()"
				class="mr-2 action secondary"
			>
				<nb-icon *gauzySpinnerButton="editing && isSelected" icon="edit-2-outline" class="mr-1"></nb-icon>
				{{ 'BUTTONS.EDIT' | translate }}
			</button>

			<button
				nbButton
				type="button"
				status="basic"
				class="action"
				[disabled]="disabled"
				size="small"
				(click)="delete()"
				[nbTooltip]="'BUTTONS.DELETE' | translate"
				*gauzySpinnerButton="deleting && isSelected"
			>
				<nb-icon icon="trash-2-outline" status="danger"></nb-icon>
			</button>
			}
		</div>
	</nb-card-footer>
</nb-card>
