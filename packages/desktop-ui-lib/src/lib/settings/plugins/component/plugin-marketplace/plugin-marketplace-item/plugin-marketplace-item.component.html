<!-- Async bindings for plugin data and various states -->
@let plugin = plugin$ | async;
<!-- Get the current plugin details -->
@let currentPlugin = marketplaceQuery.plugin$ | async;
<!-- Is Selected-->
@let isSelected = currentPlugin?.id === plugin?.id;
<!-- Installed version -->
@let installedVersionId = installedVersionId$ | async;
<!-- Async binding for editing state -->
@let editing = marketplaceQuery.updating$(plugin?.id) | async;
<!-- Check if the plugin is selected and disabled state for toggles -->
@let installed = installationQuery.installed$(plugin?.id) | async;
<!-- Determine if the plugin is currently being installed or uninstalled -->
@let installing = installationQuery.installing$(plugin?.id) | async;
<!-- Determine if the plugin is currently being uninstalled -->
@let uninstalling = installationQuery.uninstalling$(plugin?.id) | async;
<!-- Deleting state for plugins -->
@let deleting = marketplaceQuery.deleting$(plugin?.id) | async;
<!-- Adding state for versions -->
@let adding = versionQuery.creating$(plugin?.id) | async;
<!-- Update needed state -->
@let needUpdate = installed && plugin.version.id !== installedVersionId;
<!-- Loading state -->
@let loading = marketplaceQuery.isLoading$ | async;
<!-- Disabled state combining various conditions -->
@let disabled = editing || installing || uninstalling || deleting || adding;
<!-- Selected version state -->
@let selectedVersion = versionQuery.version$ | async;
<!-- Uploading state -->
@let uploading = marketplaceQuery.uploading$(plugin?.id) | async;
<!-- Progress state -->
@let progress = marketplaceQuery.uploadProgress$(plugin?.id) | async;
<!-- Sources state -->
@let sources = this.sourceQuery.sources$ | async;
<!-- Selected source state -->
@let selectedSource = this.sourceQuery.source$ | async;
<!-- Creating source state -->
@let creatingSource = this.sourceQuery.creating$(plugin?.id) | async;
<!-- Get current subscription -->
@let subscription = currentSubscription$ | async;
<!-- Subscription is loading -->
@let subscriptionLoading = subscriptionQuery.loading$ | async;

<!-- Main template -->
<nb-card class="content-active first plugin-details-card">
	<nb-card-header>
		<div class="header-content">
			<div class="header-left">
				<div class="icon-container">
					<nb-icon icon="cube-outline"></nb-icon>
				</div>
				<div class="header-info">
					<h5 class="title">{{ plugin?.name || ('SM_TABLE.NO_DATA.LOADING' | translate) }}</h5>
					<!-- Category Section -->
					@if(plugin?.category; as category) {
					<div class="category-container mb-2" [style.color]="category.color">
						<nb-icon [icon]="category.icon" class="mr-1"></nb-icon>
						<span>{{ category.name }}</span>
					</div>
					}
					<div class="badge-container">
						<nb-badge
							*ngIf="plugin"
							[status]="getStatusBadgeStatus(plugin.status)"
							[text]="getStatusLabel(plugin.status)"
							class="mr-2"
						></nb-badge>
						<!-- Subscription Status Badge -->
						<gauzy-subscription-status-badge
							*ngIf="subscription"
							[status]="subscription.status"
							class="mr-2"
						></gauzy-subscription-status-badge>
						<nb-badge
							*ngIf="plugin"
							[status]="getPluginTypeBadgeStatus(plugin.type)"
							[text]="getTypeLabel(plugin.type)"
							class="mr-2"
						></nb-badge>
						<nb-badge
							*ngIf="plugin && !plugin.hasPlan"
							status="success"
							text="Free"
							class="mr-2"
						></nb-badge>
						<!-- Access Level Badge -->
						<nb-badge
							*ngIf="accessLevel$ | async as accessLevel"
							[status]="getAccessLevelBadgeStatus(accessLevel)"
							[text]="getAccessLevelLabel(accessLevel)"
							class="mr-2"
						>
						</nb-badge>
					</div>
				</div>
			</div>
			<button nbButton ghost size="small" (click)="navigateBack()" class="close-button">
				<nb-icon icon="close-outline"></nb-icon>
			</button>
		</div>
	</nb-card-header>

	<nb-card-body>
		@if(loading) {
		<div class="d-flex justify-content-center py-5">
			<nb-spinner status="primary"></nb-spinner>
		</div>
		}@else if(!plugin) {
		<div class="no-data py-5">
			<ngx-no-data-message [message]="'SM_TABLE.NO_DATA.PLUGIN_MARKETPLACE' | translate"></ngx-no-data-message>
		</div>
		}@else {
		<div class="plugin-content">
			<!-- Quick Actions -->
			<div class="quick-actions-card">
				@if(installed) {
				<div class="installed-status">
					<div class="status-indicator">
						<nb-icon icon="checkmark-circle-2-outline" class="status-icon"></nb-icon>
						<span class="status-text">{{ 'PLUGIN.DETAILS.INSTALLED' | translate }}</span>
					</div>
					<div class="action-buttons-group">
						@if(needUpdate) {
						<button
							nbButton
							status="primary"
							size="medium"
							[disabled]="disabled"
							(click)="installUpdate()"
							class="update-button"
						>
							<nb-icon
								*gauzySpinnerButton="installing && isSelected"
								icon="sync-outline"
								class="mr-1"
							></nb-icon>
							{{ 'BUTTONS.UPDATE' | translate }}
						</button>
						}
						<button
							nbButton
							outline
							status="danger"
							size="medium"
							[disabled]="disabled"
							(click)="uninstallPlugin()"
							class="uninstall-button"
						>
							<nb-icon
								*gauzySpinnerButton="uninstalling && isSelected"
								icon="slash-outline"
								class="mr-1"
							></nb-icon>
							{{ 'BUTTONS.UNINSTALL' | translate }}
						</button>
					</div>
				</div>
				} @else {
				<div class="install-options">
					<!-- Install button with subscription check -->
					@if(plugin.hasPlan) { @if(hasAccess$ | async) {
					<!-- User has active subscription -->
					<button
						nbButton
						status="success"
						size="medium"
						class="install-button"
						[disabled]="disabled"
						(click)="installPlugin()"
						[nbTooltip]="'PLUGIN.TOOLTIP.INSTALL_WITH_SUBSCRIPTION' | translate"
					>
						<nb-icon
							*gauzySpinnerButton="installing && isSelected"
							icon="cloud-download-outline"
							class="mr-1"
						></nb-icon>
						{{ 'BUTTONS.INSTALL' | translate }}
					</button>
					} @else {
					<!-- User needs to subscribe first -->
					<button
						nbButton
						status="warning"
						size="medium"
						class="subscribe-button"
						[disabled]="disabled"
						(click)="installPlugin()"
						[nbTooltip]="'PLUGIN.TOOLTIP.SUBSCRIBE_TO_INSTALL' | translate"
					>
						<nb-icon
							*gauzySpinnerButton="(installing && isSelected) || subscriptionLoading"
							icon="lock-outline"
							class="mr-1"
						></nb-icon>
						{{ 'PLUGIN.BUTTONS.SUBSCRIBE_AND_INSTALL' | translate }}
					</button>
					} } @else {
					<!-- Free plugin - no subscription required -->
					<button
						nbButton
						status="success"
						size="medium"
						class="install-button"
						[disabled]="disabled"
						(click)="installPlugin()"
						[nbTooltip]="'PLUGIN.TOOLTIP.INSTALL_FREE' | translate"
					>
						<nb-icon
							*gauzySpinnerButton="installing && isSelected"
							icon="cloud-download-outline"
							class="mr-1"
						></nb-icon>
						{{ 'BUTTONS.INSTALL' | translate }}
					</button>
					}
				</div>
				}
			</div>

			<!-- Plugin Info Tabs with Lazy Loading -->
			<nb-route-tabset
				class="plugin-tabs"
				[tabs]="tabs$ | async"
				[activeLinkOptions]="{ exact: false }"
			></nb-route-tabset>
		</div>
		}
	</nb-card-body>

	<nb-card-footer>
		<div class="footer-content">
			<button
				nbButton
				type="button"
				outline
				status="primary"
				size="medium"
				class="back-button"
				(click)="navigateBack()"
			>
				<nb-icon icon="arrow-back-outline" class="mr-1"></nb-icon>
				{{ 'BUTTONS.BACK' | translate | titlecase }}
			</button>

			<div class="footer-actions">
				<!-- View Subscription Button (shown when plugin has subscription) -->
				@if(hasSubscription$ | async) {
				<button
					nbButton
					type="button"
					outline
					size="medium"
					status="info"
					[disabled]="disabled"
					(click)="viewSubscription()"
					class="subscription-button"
					[nbTooltip]="'PLUGIN.BUTTONS.VIEW_SUBSCRIPTION' | translate"
				>
					<nb-icon
						*gauzySpinnerButton="subscriptionLoading"
						icon="credit-card-outline"
						class="mr-1"
					></nb-icon>
					{{ 'PLUGIN.BUTTONS.VIEW_SUBSCRIPTION' | translate }}
				</button>
				}
				<!-- Owner Management Actions in Popover -->
				@if(isOwner) {
				<button
					nbButton
					type="button"
					outline
					size="medium"
					status="primary"
					[disabled]="disabled"
					[nbPopover]="ownerActionsTemplate"
					nbPopoverPlacement="top"
					nbPopoverTrigger="click"
					class="owner-actions-button"
					[nbTooltip]="'PLUGIN.BUTTONS.MANAGE_PLUGIN' | translate"
				>
					<nb-icon icon="more-vertical-outline" class="mr-1"></nb-icon>
					{{ 'PLUGIN.BUTTONS.MANAGE' | translate }}
				</button>
				}
			</div>
		</div>
	</nb-card-footer>
</nb-card>

<!-- Owner Actions Popover Template -->
<ng-template #ownerActionsTemplate>
	<nb-card class="owner-actions-popover">
		<nb-card-body class="p-0">
			<nb-list class="action-list p-0">
				@if(canAssign$ | async) {
				<nb-list-item class="action-item p-0">
					<!-- Assign Users Button (for users with canAssign permission) -->
					<button
						nbButton
						type="button"
						outline
						size="medium"
						status="info"
						fullWidth
						[disabled]="disabled"
						(click)="showAssignUsersDialog()"
						class="assign-button action-button"
					>
						<nb-icon icon="person-add-outline" class="mr-1"></nb-icon>
						{{ 'PLUGIN.BUTTONS.ASSIGN_USERS' | translate }}
					</button>
				</nb-list-item>
				}
				<nb-list-item class="action-item p-0">
					<button
						nbButton
						fullWidth
						outline
						status="info"
						[disabled]="disabled"
						(click)="openPlanCreator()"
						class="action-button"
					>
						<div class="button-content">
							<nb-icon icon="pricetags-outline" class="mr-1"></nb-icon>
							<span class="action-label">{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS' | translate }}</span>
						</div>
					</button>
				</nb-list-item>
				<nb-list-item class="action-item p-0">
					<button
						nbButton
						fullWidth
						outline
						status="primary"
						[disabled]="disabled"
						(click)="addVersion()"
						class="action-button"
					>
						<div class="button-content">
							<nb-icon *gauzySpinnerButton="adding && isSelected" icon="layers-outline"></nb-icon>
							<span class="action-label">{{ 'BUTTONS.ADD_VERSION' | translate }}</span>
						</div>
						@if(uploading && adding){
						<span class="progress-text">{{ progress | percent : '1.2-2' }}</span>
						}
					</button>
				</nb-list-item>

				<nb-list-item class="action-item p-0">
					<button
						nbButton
						fullWidth
						outline
						status="info"
						[disabled]="disabled"
						(click)="addSource()"
						class="action-button"
					>
						<div class="button-content">
							<nb-icon *gauzySpinnerButton="creatingSource && isSelected" icon="code-outline"></nb-icon>
							<span class="action-label">{{ 'BUTTONS.ADD_MORE_SOURCES' | translate }}</span>
						</div>
						@if(uploading && creatingSource){
						<span class="progress-text">{{ progress | percent : '1.2-2' }}</span>
						}
					</button>
				</nb-list-item>

				<nb-list-item class="action-item p-0">
					<button
						nbButton
						fullWidth
						outline
						status="primary"
						[disabled]="disabled"
						(click)="navigateToEdit()"
						class="action-button"
					>
						<div class="button-content">
							<nb-icon *gauzySpinnerButton="editing && isSelected" icon="edit-2-outline"></nb-icon>
							<span class="action-label">{{ 'BUTTONS.EDIT' | translate }}</span>
						</div>
					</button>
				</nb-list-item>

				<nb-list-item class="action-item p-0">
					<button
						nbButton
						fullWidth
						outline
						status="danger"
						[disabled]="disabled"
						(click)="delete()"
						class="action-button"
						*gauzySpinnerButton="deleting && isSelected"
					>
						<div class="button-content">
							<nb-icon icon="trash-2-outline"></nb-icon>
							<span class="action-label">{{ 'BUTTONS.DELETE' | translate }}</span>
						</div>
					</button>
				</nb-list-item>
			</nb-list>
		</nb-card-body>
	</nb-card>
</ng-template>
