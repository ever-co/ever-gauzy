<div
	class="subscription-plan-creator"
	[class.loading]="(loading$ | async) || (creating$ | async) || (updating$ | async) || (deleting$ | async)"
>
	<!-- Loading Overlay -->
	@if((loading$ | async) || (creating$ | async) || (updating$ | async) || (deleting$ | async)) {
	<div class="loading-overlay">
		<nb-spinner status="primary" size="large"></nb-spinner>
		<p class="loading-text">
			@if(loading$ | async) { {{ 'PLUGIN.SUBSCRIPTION.LOADING' | translate }} } @else if(creating$ | async) {
			{{ 'PLUGIN.SUBSCRIPTION.CREATING' | translate }} } @else if(updating$ | async) {
			{{ 'PLUGIN.SUBSCRIPTION.UPDATING' | translate }} } @else if(deleting$ | async) {
			{{ 'PLUGIN.SUBSCRIPTION.DELETING' | translate }} }
		</p>
	</div>
	}

	<!-- Error Alert -->
	@if(error$ | async; as error) {
	<nb-alert status="danger" closable (close)="subscriptionFacade.resetError()">
		<nb-icon icon="alert-circle-outline"></nb-icon>
		{{ error }}
	</nb-alert>
	}

	<div class="creator-header">
		<div class="header-icon">
			<nb-icon icon="pricetags-outline" status="primary"></nb-icon>
		</div>
		<div class="header-content">
			<h6>{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.TITLE' | translate }}</h6>
			<p class="text-hint">{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.DESCRIPTION' | translate }}</p>
		</div>
		<div class="header-badge" *ngIf="plans?.length > 0">
			<nb-badge [text]="plans.length + ' Plan' + (plans.length !== 1 ? 's' : '')" status="primary"></nb-badge>
		</div>
	</div>

	@if(plansForm) {
	<form [formGroup]="plansForm" class="plans-form">
		<div formArrayName="plans" class="plans-array">
			<!-- Plan Cards -->
			<div
				*ngFor="let planGroup of plans.controls; let planIndex = index"
				[formGroupName]="planIndex"
				class="plan-card"
			>
				<div class="plan-card-header">
					<div class="plan-title">
						<nb-icon icon="layers-outline" status="primary"></nb-icon>
						<span>{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.PLAN' | translate }} {{ planIndex + 1 }}</span>
						<!-- Indicator for existing vs new plans -->
						<nb-badge
							*ngIf="isExistingPlan(planIndex)"
							text="Existing"
							status="basic"
							position="top left"
						></nb-badge>
						<nb-badge
							*ngIf="!isExistingPlan(planIndex)"
							text="New"
							status="primary"
							position="top left"
						></nb-badge>
						<nb-badge
							*ngIf="planGroup.get('isPopular')?.value"
							text="Popular"
							status="success"
							position="top right"
						></nb-badge>
						<nb-badge
							*ngIf="planGroup.get('isRecommended')?.value"
							text="Recommended"
							status="info"
							position="top right"
						></nb-badge>
					</div>
					<div class="plan-actions">
						<!-- Update button for existing plans -->
						<button
							*ngIf="isExistingPlan(planIndex)"
							type="button"
							nbButton
							ghost
							size="small"
							status="primary"
							nbTooltip="{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.UPDATE_PLAN' | translate }}"
							nbTooltipPlacement="top"
							(click)="updateExistingPlan(planIndex)"
						>
							<nb-icon icon="save-outline"></nb-icon>
						</button>
						<!-- Duplicate button -->
						<button
							*ngIf="allowMultiplePlans"
							type="button"
							nbButton
							ghost
							size="small"
							status="info"
							nbTooltip="{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.DUPLICATE_PLAN' | translate }}"
							nbTooltipPlacement="top"
							(click)="duplicatePlan(planIndex)"
						>
							<nb-icon icon="copy-outline"></nb-icon>
						</button>
						<!-- Delete button (shows confirmation for existing plans) -->
						<button
							*ngIf="canRemovePlan()"
							type="button"
							nbButton
							ghost
							size="small"
							[status]="isExistingPlan(planIndex) ? 'danger' : 'basic'"
							nbTooltip="{{
								isExistingPlan(planIndex)
									? ('PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.DELETE_PLAN' | translate)
									: ('PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.REMOVE_PLAN' | translate)
							}}"
							nbTooltipPlacement="top"
							(click)="removePlan(planIndex)"
						>
							<nb-icon icon="trash-2-outline"></nb-icon>
						</button>
					</div>
				</div>

				<div class="plan-card-body">
					<!-- Plan Type -->
					<div class="form-row">
						<nb-form-field class="form-group">
							<label class="label">
								<nb-icon icon="grid-outline" status="primary"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.TYPE' | translate }} *
							</label>
							<nb-select
								fullWidth
								formControlName="type"
								placeholder="{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.SELECT_TYPE' | translate }}"
								(selectionChange)="onPlanTypeChange(planIndex)"
							>
								<nb-option *ngFor="let type of PluginSubscriptionType | keyvalue" [value]="type.value">
									<nb-icon
										[icon]="
											type.value === 'FREE'
												? 'gift-outline'
												: type.value === 'PAID'
												? 'credit-card-outline'
												: 'infinity-outline'
										"
									></nb-icon>
									{{ type.value | titlecase }}
								</nb-option>
							</nb-select>
						</nb-form-field>
					</div>

					<!-- Plan Name and Description -->
					<div class="form-row">
						<nb-form-field
							class="form-group"
							[class.has-success]="planGroup.get('name')?.valid && planGroup.get('name')?.touched"
						>
							<label class="label">
								<nb-icon icon="text-outline" status="primary"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.NAME' | translate }} *
							</label>
							<div class="input-wrapper">
								<input
									nbInput
									fullWidth
									formControlName="name"
									placeholder="{{
										'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.NAME_PLACEHOLDER' | translate
									}}"
								/>
								<nb-icon
									*ngIf="planGroup.get('name')?.valid && planGroup.get('name')?.touched"
									icon="checkmark-circle-2"
									status="success"
									class="success-icon"
								></nb-icon>
							</div>
						</nb-form-field>
					</div>

					<div class="form-row">
						<nb-form-field
							class="form-group"
							[class.has-success]="
								planGroup.get('description')?.valid && planGroup.get('description')?.touched
							"
						>
							<label class="label">
								<nb-icon icon="file-text-outline" status="primary"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.PLAN_DESCRIPTION' | translate }} *
							</label>
							<div class="input-wrapper">
								<textarea
									nbInput
									fullWidth
									formControlName="description"
									rows="3"
									placeholder="{{
										'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.DESCRIPTION_PLACEHOLDER' | translate
									}}"
								></textarea>
								<nb-icon
									*ngIf="planGroup.get('description')?.valid && planGroup.get('description')?.touched"
									icon="checkmark-circle-2"
									status="success"
									class="success-icon"
								></nb-icon>
							</div>
							<span class="char-count" *ngIf="planGroup.get('description')?.value">
								{{ planGroup.get('description')?.value.length }} characters
							</span>
						</nb-form-field>
					</div>

					<!-- Pricing -->
					<div class="form-row pricing-row">
						<nb-form-field class="form-group price-group">
							<label class="label">
								<nb-icon icon="pricetags-outline" status="success"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.PRICE' | translate }} *
							</label>
							<input
								nbInput
								fullWidth
								type="number"
								formControlName="price"
								min="0"
								step="0.01"
								placeholder="0.00"
							/>
						</nb-form-field>

						<nb-form-field class="form-group currency-group">
							<label class="label">
								<nb-icon icon="trending-up-outline" status="success"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.CURRENCY' | translate }} *
							</label>
							<nb-select fullWidth formControlName="currency">
								<nb-option value="USD">
									<nb-icon icon="dollar-sign-outline"></nb-icon>
									USD ($)
								</nb-option>
								<nb-option value="EUR">
									<nb-icon icon="euro-outline"></nb-icon>
									EUR (€)
								</nb-option>
								<nb-option value="GBP">
									<nb-icon icon="pound-outline"></nb-icon>
									GBP (£)
								</nb-option>
								<nb-option value="JPY">
									<nb-icon icon="yen-outline"></nb-icon>
									JPY (¥)
								</nb-option>
							</nb-select>
						</nb-form-field>

						<nb-form-field class="form-group billing-group">
							<label class="label">
								<nb-icon icon="calendar-outline" status="success"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.BILLING_PERIOD' | translate }} *
							</label>
							<nb-select fullWidth formControlName="billingPeriod">
								<nb-option *ngFor="let period of PluginBillingPeriod | keyvalue" [value]="period.value">
									<nb-icon icon="clock-outline"></nb-icon>
									{{ formatBillingPeriod(period.value) | titlecase }}
								</nb-option>
							</nb-select>
						</nb-form-field>
					</div>

					<!-- Price Preview -->
					<div class="price-preview" *ngIf="planGroup.get('price')?.value >= 0">
						<div class="preview-card">
							<div class="preview-label">
								<nb-icon icon="eye-outline" status="info"></nb-icon>
								<span>{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.PRICE_PREVIEW' | translate }}</span>
							</div>
							<div class="preview-value" *ngIf="planGroup.get('price')?.value === 0">
								<nb-icon icon="gift-outline" status="success"></nb-icon>
								<span class="price-text free">{{
									'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.FREE' | translate
								}}</span>
							</div>
							<div class="preview-value" *ngIf="planGroup.get('price')?.value > 0">
								<nb-icon icon="credit-card-outline" status="primary"></nb-icon>
								<span class="price-text">
									{{
										formatCurrency(planGroup.get('price')?.value, planGroup.get('currency')?.value)
									}}
									<span class="period-text"
										>/ {{ formatBillingPeriod(planGroup.get('billingPeriod')?.value) }}</span
									>
								</span>
							</div>
						</div>
					</div>

					<!-- Features -->
					<div class="form-section">
						<div class="section-header">
							<label class="label">
								<nb-icon icon="checkmark-square-outline" status="success"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.FEATURES' | translate }} *
							</label>
							<button
								type="button"
								nbButton
								ghost
								size="small"
								status="success"
								nbTooltip="Add a new feature"
								nbTooltipPlacement="top"
								(click)="addFeature(planIndex)"
							>
								<nb-icon icon="plus-circle-outline"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.ADD_FEATURE' | translate }}
							</button>
						</div>

						<div class="features-list">
							<div
								*ngFor="
									let featureControl of getPlanFeatures(planIndex).controls;
									let featureIndex = index
								"
								class="feature-item"
							>
								<nb-icon icon="checkmark-circle-2-outline" status="success"></nb-icon>
								<nb-form-field class="feature-input">
									<input
										nbInput
										fullWidth
										[formControl]="featureControl"
										placeholder="{{
											'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.FEATURE_PLACEHOLDER' | translate
										}}"
									/>
								</nb-form-field>
								<button
									*ngIf="getPlanFeatures(planIndex).length > 1"
									type="button"
									nbButton
									ghost
									size="small"
									status="danger"
									nbTooltip="Remove feature"
									nbTooltipPlacement="top"
									(click)="removeFeature(planIndex, featureIndex)"
								>
									<nb-icon icon="close-circle-outline"></nb-icon>
								</button>
							</div>
						</div>
					</div>

					<!-- Limitations -->
					<div class="form-section" formGroupName="limitations">
						<label class="label section-title">
							<nb-icon icon="lock-outline" status="warning"></nb-icon>
							{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.LIMITATIONS' | translate }}
						</label>
						<div class="limitations-grid">
							<nb-form-field class="form-group">
								<label class="label">
									<nb-icon icon="people-outline"></nb-icon>
									{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.MAX_USERS' | translate }}
								</label>
								<input
									nbInput
									fullWidth
									type="number"
									formControlName="maxUsers"
									min="1"
									placeholder="{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.UNLIMITED' | translate }}"
								/>
							</nb-form-field>

							<nb-form-field class="form-group">
								<label class="label">
									<nb-icon icon="folder-outline"></nb-icon>
									{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.MAX_PROJECTS' | translate }}
								</label>
								<input
									nbInput
									fullWidth
									type="number"
									formControlName="maxProjects"
									min="1"
									placeholder="{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.UNLIMITED' | translate }}"
								/>
							</nb-form-field>

							<nb-form-field class="form-group">
								<label class="label">
									<nb-icon icon="activity-outline"></nb-icon>
									{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.API_CALLS' | translate }}
								</label>
								<input
									nbInput
									fullWidth
									type="number"
									formControlName="apiCallsPerMonth"
									min="1"
									placeholder="{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.UNLIMITED' | translate }}"
								/>
							</nb-form-field>

							<nb-form-field class="form-group">
								<label class="label">
									<nb-icon icon="hard-drive-outline"></nb-icon>
									{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.STORAGE_LIMIT' | translate }}
								</label>
								<input
									nbInput
									fullWidth
									type="number"
									formControlName="storageLimit"
									min="1"
									placeholder="{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.UNLIMITED' | translate }}"
								/>
							</nb-form-field>
						</div>
					</div>

					<!-- Additional Options -->
					<div class="form-section">
						<label class="label section-title">
							<nb-icon icon="settings-2-outline" status="info"></nb-icon>
							{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.ADDITIONAL_OPTIONS' | translate }}
						</label>
						<div class="options-grid">
							<nb-form-field class="form-group">
								<label class="label">
									<nb-icon icon="clock-outline"></nb-icon>
									{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.TRIAL_DAYS' | translate }}
								</label>
								<input
									nbInput
									fullWidth
									type="number"
									formControlName="trialDays"
									min="0"
									max="365"
									placeholder="0"
								/>
							</nb-form-field>

							<nb-form-field class="form-group">
								<label class="label">
									<nb-icon icon="credit-card-outline"></nb-icon>
									{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.SETUP_FEE' | translate }}
								</label>
								<input
									nbInput
									fullWidth
									type="number"
									formControlName="setupFee"
									min="0"
									step="0.01"
									placeholder="0.00"
								/>
							</nb-form-field>

							<nb-form-field class="form-group">
								<label class="label">
									<nb-icon icon="percent-outline"></nb-icon>
									{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.DISCOUNT' | translate }}
								</label>
								<input
									nbInput
									fullWidth
									type="number"
									formControlName="discountPercentage"
									min="0"
									max="100"
									placeholder="0"
								/>
							</nb-form-field>
						</div>

						<div class="checkboxes-row">
							<nb-checkbox formControlName="isPopular">
								<nb-icon icon="star-outline" status="success"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.POPULAR' | translate }}
							</nb-checkbox>
							<nb-checkbox formControlName="isRecommended">
								<nb-icon icon="award-outline" status="info"></nb-icon>
								{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.RECOMMENDED' | translate }}
							</nb-checkbox>
						</div>
					</div>
				</div>
			</div>

			<!-- Add Plan Button -->
			<div *ngIf="canAddPlan()" class="add-plan-section">
				<button
					type="button"
					nbButton
					ghost
					status="primary"
					size="large"
					(click)="addPlan()"
					class="add-plan-button"
					nbTooltip="Create a new subscription plan"
					nbTooltipPlacement="top"
				>
					<nb-icon icon="plus-circle-outline"></nb-icon>
					{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.ADD_PLAN' | translate }}
				</button>
			</div>

			<!-- No Plans Message -->
			<div *ngIf="plans.length === 0" class="no-plans-message">
				<nb-alert status="warning" size="medium" closable="false">
					<div style="display: flex; align-items: center; gap: 1rem">
						<nb-icon icon="alert-circle-outline" style="font-size: 2rem"></nb-icon>
						<div>
							<strong>{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.NO_PLANS' | translate }}</strong>
							<p style="margin: 0.5rem 0 0 0; opacity: 0.8">
								Get started by creating your first subscription plan
							</p>
						</div>
					</div>
				</nb-alert>
			</div>
		</div>
	</form>
	}@else {
	<div class="no-plans-message">
		<nb-alert status="warning" size="medium" closable="false">
			<div style="display: flex; align-items: center; gap: 1rem">
				<nb-icon icon="alert-circle-outline" style="font-size: 2rem"></nb-icon>
				<div>
					<strong>{{ 'PLUGIN.FORM.SUBSCRIPTION_PLANS_CREATOR.NO_PLANS' | translate }}</strong>
					<p style="margin: 0.5rem 0 0 0; opacity: 0.8">
						Initialize the form to start creating subscription plans
					</p>
				</div>
			</div>
		</nb-alert>
	</div>
	}
</div>
