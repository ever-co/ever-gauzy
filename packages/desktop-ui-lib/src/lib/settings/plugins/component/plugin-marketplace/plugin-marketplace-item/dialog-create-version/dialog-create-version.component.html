<form [formGroup]="versionForm" (ngSubmit)="submit()">
	<nb-card class="dialog-card" status="basic">
		<nb-card-header class="mb-0">
			<h5 class="title">
				{{
					version
						? ('PLUGIN.DIALOG.VERSION.UPDATE.TITLE' | translate : { number: version.number })
						: ('PLUGIN.DIALOG.VERSION.CREATE.TITLE' | translate : { name: plugin?.name })
				}}
			</h5>
			<button nbButton ghost size="small" (click)="dismiss()" class="close-button">
				<nb-icon icon="close-outline"></nb-icon>
			</button>
		</nb-card-header>
		<nb-card-body>
			<nb-stepper orientation="horizontal" #stepper>
				<!-- Step 1 : Sources -->
				<nb-step [stepControl]="versionForm?.get('sources')" [label]="'PLUGIN.FORM.SOURCES' | translate">
					<div class="sources-container">
						<!-- Sources List with Drag & Drop -->
						<div cdkDropList (cdkDropListDropped)="drop($event)" class="sources-list">
							@for(source of sources.controls; track source; let idx = $index){
							<div class="source-card" cdkDrag>
								<!-- Glow effect on hover -->
								<div class="card-glow"></div>

								<div class="source-header">
									<div class="drag-area" cdkDragHandle>
										<h5>{{ 'PLUGIN.FORM.SOURCE' | translate }} #{{ idx + 1 }}</h5>
										<nb-icon icon="grid-view" class="drag-icon"></nb-icon>
									</div>
									@if(sources.length > 1){
									<button
										nbButton
										ghost
										status="danger"
										size="small"
										(click)="removeSource(idx)"
										class="delete-btn"
										[nbTooltip]="'Delete source' | translate"
										nbTooltipPlacement="top"
									>
										<nb-icon icon="trash-2-outline"></nb-icon>
									</button>
									}
								</div>
								<lib-plugin-source class="grow" [form]="source"></lib-plugin-source>
							</div>
							} @empty {
							<div class="empty-state">
								<nb-icon icon="file-add-outline" class="empty-icon"></nb-icon>
								<h5>{{ 'No Source' | translate }}</h5>
								<p>{{ 'Add First Source' | translate }}</p>
							</div>
							}
						</div>

						<!-- Add Source Section -->
						<div class="add-source">
							<div class="add-source-card" (click)="openSourceTypeSelector(); $event.stopPropagation()">
								<div class="add-content">
									<nb-icon icon="plus-circle-outline" class="add-icon"></nb-icon>
									<h5>{{ 'Add New Source' | translate }}</h5>
									<p>{{ 'Click to select source' | translate }}</p>
								</div>

								<div class="source-selector" *ngIf="showSourceSelector">
									<div class="selector-header">
										<h5>Select Source Type</h5>
										<button
											nbButton
											ghost
											size="small"
											(click)="closeSourceTypeSelector(); $event.stopPropagation()"
										>
											<nb-icon icon="close-outline"></nb-icon>
										</button>
									</div>
									<div class="source-options">
										@for(source of sourceTypes; track source){
										<div
											class="source-option"
											(click)="addSource(source); $event.stopPropagation()"
										>
											<nb-icon [icon]="getSourceIcon(source)" class="option-icon"></nb-icon>
											<span>{{ 'PLUGIN.FORM.SOURCE_TYPES.' + source | translate }}</span>
										</div>
										}
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="stepper-buttons">
						<button nbButton status="primary" nbStepperNext>{{ 'BUTTONS.NEXT' | translate }}</button>
					</div>
				</nb-step>

				<!-- Step 2: Version -->
				<nb-step [stepControl]="versionForm?.get('number')" [label]="'PLUGIN.FORM.VERSION' | translate">
					<lib-plugin-version class="grow" [form]="versionForm"></lib-plugin-version>
					<div class="stepper-buttons">
						<button nbButton outline status="basic" nbStepperPrevious>
							{{ 'BUTTONS.PREVIOUS' | translate }}
						</button>
						<button nbButton status="primary" type="submit" [disabled]="isFormInvalid || isSubmitting">
							{{
								version
									? ('BUTTONS.UPDATE' | translate)
									: ('BUTTONS.CREATE' | translate) + (versionNumber ? ' v' + versionNumber : '')
							}}
						</button>
					</div>
				</nb-step>
			</nb-stepper>
		</nb-card-body>
	</nb-card>
</form>
