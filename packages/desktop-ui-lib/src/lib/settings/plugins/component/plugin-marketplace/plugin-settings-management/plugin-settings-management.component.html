@let filteredGroups = filteredGroups$ | async; @let categories = categories$ | async; @let loading = loading$ | async;

<nb-card class="plugin-settings-management">
	<nb-card-header class="d-flex justify-content-between align-items-center">
		<div class="header-info">
			<div class="header-icon-container">
				<nb-icon icon="settings-2-outline"></nb-icon>
			</div>
			<div class="header-content">
				<h5 class="card-title mb-1">Plugin Settings - {{ plugin.name }}</h5>
				<p class="card-subtitle text-hint mb-0">Configure and manage plugin settings and preferences</p>
			</div>
		</div>
		<div class="header-actions">
			<button
				nbButton
				ghost
				size="small"
				status="success"
				(click)="onCreateSetting()"
				nbTooltip="Create a new setting"
				class="me-2"
			>
				<nb-icon icon="plus-outline"></nb-icon>
				New Setting
			</button>
			<button
				nbButton
				ghost
				size="small"
				status="warning"
				(click)="onResetSettings()"
				nbTooltip="Reset all settings to default values"
			>
				<nb-icon icon="refresh-outline"></nb-icon>
				Reset
			</button>
		</div>
	</nb-card-header>

	<nb-card-body>
		<!-- Search and Filter Controls -->
		<form [formGroup]="searchForm" class="filter-controls mb-4">
			<div class="controls-header">
				<nb-icon icon="options-2-outline" class="controls-icon"></nb-icon>
				<span class="controls-label">Search & Filter</span>
			</div>
			<div class="row">
				<div class="col-md-8">
					<nb-form-field>
						<nb-icon nbPrefix icon="search-outline"></nb-icon>
						<input
							nbInput
							placeholder="Search settings by name, key, or description..."
							formControlName="searchTerm"
							class="search-input"
						/>
					</nb-form-field>
				</div>
				<div class="col-md-4">
					<div class="form-group">
						<gauzy-category-selector [categoryId]="categoryId?.value"></gauzy-category-selector>
					</div>
				</div>
			</div>
		</form>

		<!-- Settings Form -->
		@if(loading) {
		<div class="loading-state">
			<nb-spinner size="large"></nb-spinner>
			<span class="loading-text">Loading plugin settings...</span>
		</div>
		} @else if(filteredGroups && filteredGroups.length > 0) {
		<form [formGroup]="settingsForm" class="settings-form">
			@for(group of filteredGroups; track group.category) {
			<nb-card class="settings-group-card">
				<nb-card-header class="group-header">
					<div class="group-info">
						<nb-icon [icon]="group.icon || 'settings-outline'" class="group-icon"></nb-icon>
						<div>
							<h6 class="group-title">{{ group.label }}</h6>
							@if(group.description) {
							<p class="group-description">{{ group.description }}</p>
							}
						</div>
					</div>
					<nb-badge
						status="basic"
						class="settings-count"
						[text]="group.settings.length + ' setting' + (group.settings.length !== 1 ? 's' : '')"
					>
					</nb-badge>
				</nb-card-header>

				<nb-card-body class="group-body">
					<div class="settings-grid">
						@for(setting of group.settings; track setting.key) {
						<div class="setting-item" [class.has-error]="hasSettingError(setting.key)">
							<div class="setting-header">
								<div class="setting-info">
									<label class="setting-label" [for]="setting.key">
										<nb-icon
											[icon]="getSettingTypeIcon(setting.type)"
											class="setting-type-icon"
										></nb-icon>
										{{ setting.label }}
										@if(setting.isRequired) {
										<span class="required-indicator">*</span>
										}
									</label>
									@if(setting.description) {
									<p class="setting-description">{{ setting.description }}</p>
									}
								</div>
								<div class="setting-meta">
									<nb-badge
										status="basic"
										size="tiny"
										[text]="formatSettingType(setting.type)"
										class="type-badge"
									>
									</nb-badge>
									<button
										nbButton
										ghost
										size="tiny"
										status="danger"
										(click)="onDeleteSetting(setting.id, setting.key)"
										nbTooltip="Delete this setting"
										class="delete-setting-btn"
									>
										<nb-icon icon="trash-2-outline"></nb-icon>
									</button>
								</div>
							</div>

							<div class="setting-control">
								<!-- Boolean Toggle -->
								@if(isBooleanType(setting.type)) {
								<nb-toggle [formControlName]="setting.key" [id]="setting.key"> </nb-toggle>
								}

								<!-- Select Dropdown -->
								@else if(isSelectType(setting.type)) {
								<nb-select
									[formControlName]="setting.key"
									[id]="setting.key"
									[placeholder]="'Select ' + setting.label"
								>
									@for(option of setting.options; track option.value) {
									<nb-option [value]="option.value" [disabled]="option.disabled">
										@if(option.icon) {
										<nb-icon [icon]="option.icon"></nb-icon>
										}
										{{ option.label }}
										@if(option.description) {
										<small class="option-description">{{ option.description }}</small>
										}
									</nb-option>
									}
								</nb-select>
								}

								<!-- Multi-Select -->
								@else if(isMultiSelectType(setting.type)) {
								<nb-select
									[formControlName]="setting.key"
									[id]="setting.key"
									[placeholder]="'Select ' + setting.label"
									multiple
								>
									@for(option of setting.options; track option.value) {
									<nb-option [value]="option.value" [disabled]="option.disabled">
										{{ option.label }}
									</nb-option>
									}
								</nb-select>
								}

								<!-- Textarea -->
								@else if(isTextAreaType(setting.type)) {
								<textarea
									nbInput
									fullWidth
									[formControlName]="setting.key"
									[id]="setting.key"
									[placeholder]="setting.description || 'Enter ' + setting.label"
									rows="4"
								>
								</textarea>
								}

								<!-- Number/Range Input -->
								@else if(isNumberType(setting.type)) {
								<input
									nbInput
									fullWidth
									[type]="getInputType(setting.type)"
									[formControlName]="setting.key"
									[id]="setting.key"
									[placeholder]="setting.description || 'Enter ' + setting.label"
									[min]="setting.validation?.min"
									[max]="setting.validation?.max"
								/>
								}

								<!-- Date/Time Input -->
								@else if(isDateType(setting.type)) {
								<input
									nbInput
									fullWidth
									[type]="getInputType(setting.type)"
									[formControlName]="setting.key"
									[id]="setting.key"
								/>
								}

								<!-- Default Text Input -->
								@else {
								<input
									nbInput
									fullWidth
									[type]="getInputType(setting.type)"
									[formControlName]="setting.key"
									[id]="setting.key"
									[placeholder]="setting.description || 'Enter ' + setting.label"
									[minlength]="setting.validation?.minLength"
									[maxlength]="setting.validation?.maxLength"
								/>
								}

								<!-- Validation Error Message -->
								@if(hasSettingError(setting.key)) {
								<div class="error-message">
									<nb-icon icon="alert-circle-outline"></nb-icon>
									{{ getSettingErrorMessage(setting.key) }}
								</div>
								}
							</div>

							<!-- Setting Metadata -->
							@if(setting.defaultValue !== undefined) {
							<div class="setting-footer">
								<small class="default-value"> Default: {{ setting.defaultValue }} </small>
							</div>
							}
						</div>
						}
					</div>
				</nb-card-body>
			</nb-card>
			}
		</form>
		} @else {
		<div class="empty-state">
			<div class="empty-icon-container">
				<nb-icon icon="settings-outline" class="empty-icon"></nb-icon>
			</div>
			<p class="empty-text">No settings found</p>
			<small class="empty-hint">
				No settings match your current search criteria or this plugin has no configurable settings.
			</small>
		</div>
		}
	</nb-card-body>

	<nb-card-footer class="d-flex justify-content-between align-items-center">
		<div class="form-info">
			@if(settingsForm.dirty) {
			<small class="unsaved-changes">
				<nb-icon icon="alert-triangle-outline" status="warning"></nb-icon>
				You have unsaved changes
			</small>
			}
		</div>
		<div class="form-actions">
			<button nbButton ghost status="basic" (click)="close()" class="me-2">Cancel</button>
			<button
				nbButton
				status="primary"
				[disabled]="!settingsForm.valid || !settingsForm.dirty || submitting"
				(click)="onSaveSettings()"
			>
				<nb-icon *gauzySpinnerButton="submitting" icon="save-outline"></nb-icon>
				Save Settings
			</button>
		</div>
	</nb-card-footer>
</nb-card>
