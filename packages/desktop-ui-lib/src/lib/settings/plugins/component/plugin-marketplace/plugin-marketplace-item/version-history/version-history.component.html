@let versions = query.versions$ | async; @let isAvailable = (query.count$ | async) > 0; @let isRemoving =
query.deleting$ | async; @let isRecovering = query.restoring$ | async; @let isLoading = (query.isLoading$ | async) &&
versions.length === 0; @let isEditing = query.updating$ | async; @let isDisabled = isRemoving || isRecovering ||
isEditing; @let selectedVersionId = (query.version$ | async)?.id;

<nb-card class="content-active first">
	<nb-card-header class="header">
		<div class="header-content">
			<div class="header-left">
				<div class="icon-container">
					<nb-icon icon="clock-outline"></nb-icon>
				</div>
				<h5 class="title">{{ 'PLUGIN.LAYOUT.VERSION_HISTORY' | translate }}</h5>
			</div>
			<button nbButton ghost size="small" (click)="navigateBack()" class="close-button">
				<nb-icon icon="close-outline"></nb-icon>
			</button>
		</div>
	</nb-card-header>

	@if (isAvailable) {
	<nb-card-body
		nbInfiniteList
		[threshold]="500"
		[throttleTime]="300"
		(bottomThreshold)="loadMore()"
		class="version-container"
	>
		@for (version of versions; track version.id) { @defer (on viewport; when isLoading) {
		<nb-card class="version-card">
			<nb-card-header>
				<div class="version-header">
					<div class="version-info">
						<nb-icon icon="git-commit-outline" class="version-icon"></nb-icon>
						<div class="version-details">
							<div class="version-number-badge">
								<nb-icon icon="layers-outline" class="badge-icon"></nb-icon>
								<span>{{ version.number }}</span>
							</div>
							<time [dateTime]="version.releaseDate" class="version-date">
								{{ version.releaseDate | date : 'MMMM d, y' }}
							</time>
						</div>
					</div>
					@if(version.deletedAt) {
					<nb-badge status="danger" text="Deleted" position="top right"></nb-badge>
					}
				</div>
			</nb-card-header>
			<nb-card-body class="changelog">
				<p
					[readMore]="256"
					[readMoreText]="'BUTTONS.READ_MORE' | translate"
					[readLessText]="'BUTTONS.READ_LESS' | translate"
				>
					{{ version.changelog }}
				</p>
			</nb-card-body>
			@if(isOwner(version)){
			<nb-card-footer class="version-actions">
				@if(version.deletedAt) {
				<button
					nbButton
					size="small"
					type="button"
					status="warning"
					class="recover-button"
					(click)="restore(version)"
					[disabled]="isDisabled"
				>
					<nb-icon
						*gauzySpinnerButton="selectedVersionId === version.id && isRecovering"
						icon="refresh-outline"
						class="mr-1"
					></nb-icon>
					{{ 'BUTTONS.RECOVER' | translate }}
				</button>
				} @else {
				<button
					nbButton
					size="small"
					type="button"
					outline
					status="primary"
					class="edit-button"
					[disabled]="isDisabled"
					(click)="edit(version)"
				>
					<nb-icon
						*gauzySpinnerButton="selectedVersionId === version.id && isEditing"
						icon="edit-2-outline"
						class="mr-1"
					></nb-icon>
					{{ 'BUTTONS.EDIT' | translate }}
				</button>
				<button
					nbButton
					[nbTooltip]="'BUTTONS.DELETE' | translate"
					size="small"
					type="button"
					outline
					status="danger"
					class="delete-button"
					(click)="remove(version)"
					[disabled]="isDisabled"
				>
					<nb-icon
						*gauzySpinnerButton="selectedVersionId === version.id && isRemoving"
						icon="trash-2-outline"
					></nb-icon>
				</button>
				}
			</nb-card-footer>
			}
		</nb-card>
		} @placeholder(minimum 500ms) {
		<nb-card class="version skeleton-loader">
			<nb-card-header>
				<h6 class="title">
					<div class="skeleton-line date" style="width: 120px"></div>
					<div class="skeleton-line version-number" style="width: 60px"></div>
				</h6>
			</nb-card-header>

			<nb-card-body class="changelog">
				<div class="skeleton-line" style="width: 100%; height: 16px; margin-bottom: 8px"></div>
				<div class="skeleton-line" style="width: 90%; height: 16px; margin-bottom: 8px"></div>
				<div class="skeleton-line" style="width: 80%; height: 16px"></div>
			</nb-card-body>

			<nb-card-footer class="version-actions">
				<div class="skeleton-button" style="width: 80px; height: 32px"></div>
				<div class="skeleton-button" style="width: 32px; height: 32px; margin-left: 8px"></div>
			</nb-card-footer>
		</nb-card>
		} }
	</nb-card-body>
	} @else if (isLoading) {
	<ngx-no-data-message [message]="'SM_TABLE.NO_DATA.LOADING' | translate"></ngx-no-data-message>
	} @else {
	<ngx-no-data-message [message]="'SM_TABLE.NO_DATA.HISTORY' | translate"></ngx-no-data-message>
	}

	<nb-card-footer class="footer">
		<button
			nbButton
			type="button"
			outline
			status="primary"
			size="medium"
			class="back-button"
			(click)="navigateBack()"
		>
			<nb-icon icon="arrow-back-outline" class="mr-1"></nb-icon>
			{{ 'BUTTONS.BACK' | translate | titlecase }}
		</button>
	</nb-card-footer>
</nb-card>
