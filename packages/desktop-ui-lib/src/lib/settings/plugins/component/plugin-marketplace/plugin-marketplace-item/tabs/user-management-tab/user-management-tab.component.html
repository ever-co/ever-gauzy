<!-- User Management Tab Template -->
<!-- Uses reactive programming with async pipe and proper null-safety -->
@let plugin = plugin$ | async; @let viewModel = viewModel$ | async; @let canAssign = canAssign$ | async; @let hasMore =
hasMore$ | async; @let loadingMore = loadingMore$ | async; @if (plugin && viewModel) {
<div class="user-management-tab-content">
	<!-- Header Section -->
	<div class="header-section mb-4">
		<div class="header-card">
			<div class="header-left">
				<div class="header-icon">
					<nb-icon icon="people-outline" status="primary"></nb-icon>
				</div>
				<div class="header-info">
					<h6 class="section-title">{{ 'PLUGIN.USER_MANAGEMENT.TITLE' | translate }}</h6>
					<p class="section-description">
						{{ 'PLUGIN.USER_MANAGEMENT.DESCRIPTION' | translate }}
					</p>
				</div>
			</div>
			@if (canAssign) {
			<button
				nbButton
				status="primary"
				size="medium"
				(click)="showAssignmentDialog()"
				class="assign-users-btn"
				[disabled]="viewModel.loading"
			>
				<nb-icon icon="person-add-outline"></nb-icon>
				<span>{{ 'PLUGIN.BUTTONS.ASSIGN_USERS' | translate }}</span>
			</button>
			}
		</div>
	</div>

	<!-- Stats Summary -->
	@if (viewModel.hasAssignments) {
	<div class="stats-card mb-4">
		<div class="stat-item total-stat">
			<div class="stat-icon">
				<nb-icon icon="people-outline" status="primary"></nb-icon>
			</div>
			<div class="stat-content">
				<span class="stat-label">{{ 'PLUGIN.USER_MANAGEMENT.TOTAL_ASSIGNED' | translate }}</span>
				<span class="stat-value">{{ viewModel.totalAssignmentsCount }}</span>
			</div>
		</div>
		<div class="stat-divider"></div>
		<div class="stat-item active-stat">
			<div class="stat-icon">
				<nb-icon icon="checkmark-circle-2-outline" status="success"></nb-icon>
			</div>
			<div class="stat-content">
				<span class="stat-label">{{ 'PLUGIN.USER_MANAGEMENT.ACTIVE_USERS' | translate }}</span>
				<span class="stat-value">{{ viewModel.activeAssignmentsCount }}</span>
			</div>
		</div>
	</div>
	}

	<!-- Error State -->
	@if (viewModel.hasError) {
	<nb-alert status="danger" class="mb-4">
		<div class="d-flex align-items-center justify-content-between">
			<div>
				<nb-icon icon="alert-triangle-outline" class="mr-2"></nb-icon>
				<span>{{ viewModel.error }}</span>
			</div>
		</div>
	</nb-alert>
	}

	<!-- Assigned Users List with Infinite Scroll -->
	<div class="assigned-users-section">
		<div class="section-header">
			<nb-icon icon="list-outline" status="primary"></nb-icon>
			<h6 class="section-title">{{ 'PLUGIN.USER_MANAGEMENT.ASSIGNED_USERS' | translate }}</h6>
		</div>

		<!-- Loading State -->
		@if (viewModel.loading) {
		<div class="loading-state">
			<nb-spinner size="medium"></nb-spinner>
			<span class="loading-text">{{ 'SM_TABLE.LOADING' | translate }}</span>
		</div>
		}

		<!-- Users List with Infinite Scroll -->
		@else if (viewModel.hasAssignments) {
		<div
			class="users-list-container"
			libInfiniteScroll
			[scrollThreshold]="200"
			[debounceTime]="300"
			[disabled]="!hasMore || loadingMore"
			(scrolled)="onLoadMore()"
		>
			<div class="users-list">
				@for (assignment of viewModel.assignments; track trackByAssignmentId($index, assignment); let isLast =
				$last) {
				<div class="user-assignment-item">
					<div class="user-card">
						<div class="user-info">
							<nb-user
								[picture]="getUserAvatar(assignment.user)"
								[name]="getUserDisplayName(assignment)"
								[title]="assignment.user?.email || 'N/A'"
								size="large"
							></nb-user>
						</div>

						<div class="assignment-metadata">
							<div class="metadata-row">
								<div class="metadata-item">
									<nb-icon icon="calendar-outline" class="metadata-icon"></nb-icon>
									<span class="metadata-text">
										{{ 'PLUGIN.USER_MANAGEMENT.ASSIGNED_ON' | translate }}: @if
										(getAssignmentDate(assignment); as assignedDate) {
										{{ assignedDate | date : 'medium' }}
										} @else { N/A }
									</span>
								</div>
								@if (assignment.reason) {
								<div class="metadata-item">
									<nb-icon icon="message-circle-outline" class="metadata-icon"></nb-icon>
									<span class="metadata-text">{{ assignment.reason }}</span>
								</div>
								}
							</div>

							<div class="status-badge">
								@let statusBadge = getStatusBadge(assignment);
								<nb-badge
									[status]="statusBadge.status"
									[text]="statusBadge.text | translate"
								></nb-badge>
							</div>
						</div>
					</div>

					@if (canAssign && isActive(assignment)) {
					<div class="assignment-actions">
						<button
							nbButton
							ghost
							size="small"
							status="danger"
							(click)="onUnassignUser(assignment)"
							[nbTooltip]="'PLUGIN.USER_MANAGEMENT.UNASSIGN' | translate"
							[disabled]="viewModel.loading"
							class="unassign-btn"
						>
							<nb-icon icon="person-remove-outline"></nb-icon>
						</button>
					</div>
					}
				</div>
				@if (!isLast) {
				<nb-divider></nb-divider>
				} }
			</div>

			<!-- Loading More Indicator -->
			@if (loadingMore) {
			<div class="loading-more-state">
				<nb-spinner size="small"></nb-spinner>
				<span class="loading-text">{{ 'SM_TABLE.LOADING_MORE' | translate }}</span>
			</div>
			}

			<!-- End of List Indicator -->
			@if (!hasMore && !loadingMore) {
			<div class="end-of-list">
				<span class="text-hint">{{ 'PLUGIN.USER_MANAGEMENT.END_OF_LIST' | translate }}</span>
			</div>
			}
		</div>
		}

		<!-- Empty State -->
		@else if (viewModel.isEmpty) {
		<div class="empty-state">
			<nb-icon icon="person-outline" class="empty-icon"></nb-icon>
			<p class="empty-text">{{ 'PLUGIN.USER_MANAGEMENT.NO_USERS_ASSIGNED' | translate }}</p>
			<small class="empty-hint">
				{{ 'PLUGIN.USER_MANAGEMENT.NO_USERS_HINT' | translate }}
			</small>
			@if (canAssign) {
			<button
				nbButton
				status="primary"
				size="small"
				(click)="showAssignmentDialog()"
				class="mt-3"
				[disabled]="viewModel.loading"
			>
				<nb-icon icon="person-add-outline" class="mr-1"></nb-icon>
				{{ 'PLUGIN.BUTTONS.ASSIGN_FIRST_USER' | translate }}
			</button>
			}
		</div>
		}
	</div>
</div>
} @else {
<!-- Plugin Loading State -->
<div class="loading-state">
	<nb-spinner size="medium"></nb-spinner>
	<span class="loading-text">{{ 'PLUGIN.LOADING' | translate }}</span>
</div>
}
