@let plans = availablePlans$ | async;
@let selectedPlan = selectedPlan$ | async;
@let loading = loading$ | async;
@let error = error$ | async;
@let creating = creating$ | async;
@let preview = subscriptionPreview$ | async;
@let hasFreePlans = hasFreePlan$ | async;
@let hasPaidPlans = hasPaidPlans$ | async;

<nb-card class="subscription-selection-dialog">
	<nb-card-header class="dialog-header">
		<div class="header-content">
			<div class="plugin-info">
				<nb-icon icon="puzzle-outline" class="plugin-icon"></nb-icon>
				<div class="plugin-details">
					<h4 class="plugin-name">{{ plugin?.name || 'Plugin' }}</h4>
					<p class="plugin-description">{{ plugin?.description || 'Choose a subscription plan to continue' }}</p>
				</div>
			</div>
		</div>
	</nb-card-header>

	<nb-card-body class="dialog-body">
		@if (loading) {
			<div class="loading-container">
				<nb-spinner size="large" status="primary"></nb-spinner>
				<p class="loading-text">Loading subscription plans...</p>
			</div>
		} @else if (error) {
			<nb-alert status="danger" closable="false">
				<nb-icon icon="alert-triangle-outline"></nb-icon>
				{{ error }}
			</nb-alert>
			<div class="error-actions">
				<button nbButton status="basic" (click)="loadSubscriptionPlans()">
					<nb-icon icon="refresh-outline"></nb-icon>
					Retry
				</button>
			</div>
		} @else {
			<form [formGroup]="subscriptionForm" class="subscription-form">
				<!-- Subscription Plans -->
				<div class="plans-section">
					<h5 class="section-title">
						<nb-icon icon="credit-card-outline"></nb-icon>
						Choose Your Plan
					</h5>

					@if (plans && plans.length > 0) {
						<div class="plans-grid" [class.single-plan]="plans.length === 1">
							@for (plan of plans; track plan.id) {
								<div
									class="plan-card"
									[class.selected]="selectedPlan?.id === plan.id"
									[class.popular]="plan.isPopular"
									[class.recommended]="plan.isRecommended"
									(click)="selectPlan(plan)">

									<!-- Plan Header -->
									<div class="plan-header">
										<div class="plan-type">
											<nb-icon [icon]="getPlanTypeIcon(plan.type)"></nb-icon>
											<span class="plan-name">{{ plan.name }}</span>
										</div>
										<nb-badge
											[status]="getPlanTypeColor(plan.type)"
											[text]="plan.type | titlecase"
											class="plan-badge">
										</nb-badge>

										@if (plan.isPopular) {
											<nb-badge status="warning" text="Popular" class="popular-badge"></nb-badge>
										}
										@if (plan.isRecommended) {
											<nb-badge status="info" text="Recommended" class="recommended-badge"></nb-badge>
										}
									</div>

									<!-- Plan Pricing -->
									<div class="plan-pricing">
										@if (plan.type === PluginSubscriptionType.FREE) {
											<div class="price-display">
												<span class="price-amount">Free</span>
											</div>
										} @else {
											<div class="price-display">
												<span class="price-amount">{{ formatPrice(plan.price, plan.currency) }}</span>
												<span class="price-period">/ {{ formatBillingPeriod(plan.billingPeriod) }}</span>
											</div>
											@if (plan.setupFee && plan.setupFee > 0) {
												<div class="setup-fee">
													Setup fee: {{ formatPrice(plan.setupFee, plan.currency) }}
												</div>
											}
											@if (plan.discountPercentage && plan.discountPercentage > 0) {
												<div class="discount">
													<nb-badge status="success" [text]="plan.discountPercentage + '% OFF'"></nb-badge>
												</div>
											}
										}

										@if (plan.trialDays && plan.trialDays > 0) {
											<div class="trial-info">
												<nb-icon icon="clock-outline"></nb-icon>
												{{ plan.trialDays }} days free trial
											</div>
										}
									</div>

									<!-- Plan Description -->
									<div class="plan-description">
										<p>{{ plan.description }}</p>
									</div>

									<!-- Plan Features -->
									<div class="plan-features">
										<h6 class="features-title">Features included:</h6>
										<ul class="features-list">
											@for (feature of plan.features; track feature) {
												<li class="feature-item">
													<nb-icon icon="checkmark-outline" status="success"></nb-icon>
													<span>{{ feature }}</span>
												</li>
											}
										</ul>
									</div>

									<!-- Plan Limitations -->
									@if (plan.limitations && Object.keys(plan.limitations).length > 0) {
										<div class="plan-limitations">
											<h6 class="limitations-title">Limitations:</h6>
											<ul class="limitations-list">
												@for (limitation of Object.entries(plan.limitations); track limitation[0]) {
													<li class="limitation-item">
														<nb-icon icon="info-outline" status="warning"></nb-icon>
														<span>{{ limitation[0] }}: {{ limitation[1] }}</span>
													</li>
												}
											</ul>
										</div>
									}

									<!-- Selection Radio -->
									<div class="plan-selection">
										<nb-radio
											[value]="plan.id"
											formControlName="planId"
											[checked]="selectedPlan?.id === plan.id">
											Select this plan
										</nb-radio>
									</div>
								</div>
							}
						</div>
					} @else {
						<nb-alert status="info" closable="false">
							<nb-icon icon="info-outline"></nb-icon>
							No subscription plans available for this plugin.
						</nb-alert>
					}
				</div>

				<!-- Billing Options (for paid plans) -->
				@if (selectedPlan && selectedPlan.type !== PluginSubscriptionType.FREE) {
					<div class="billing-section">
						<h5 class="section-title">
							<nb-icon icon="calendar-outline"></nb-icon>
							Billing Options
						</h5>

						<div class="billing-period-selector">
							<nb-button-group>
								@for (period of [PluginBillingPeriod.MONTHLY, PluginBillingPeriod.YEARLY]; track period) {
									<button
										type="button"
										nbButton
										[status]="subscriptionForm.get('billingPeriod')?.value === period ? 'primary' : 'basic'"
										(click)="onBillingPeriodChange(period)">
										{{ formatBillingPeriod(period) }}
									</button>
								}
							</nb-button-group>
						</div>

						<!-- Promo Code -->
						<div class="promo-code-section">
							<nb-form-field>
								<nb-icon nbPrefix icon="gift-outline"></nb-icon>
								<input
									nbInput
									type="text"
									placeholder="Enter promo code (optional)"
									formControlName="promoCode">
								<button
									nbSuffix
									nbButton
									ghost
									size="small"
									type="button"
									(click)="validatePromoCode()"
									[disabled]="!subscriptionForm.get('promoCode')?.value">
									Apply
								</button>
							</nb-form-field>
						</div>
					</div>
				}

				<!-- Subscription Preview -->
				@if (preview && selectedPlan) {
					<div class="preview-section">
						<h5 class="section-title">
							<nb-icon icon="file-text-outline"></nb-icon>
							Order Summary
						</h5>

						<div class="preview-card">
							<div class="preview-item">
								<span class="item-label">Plan:</span>
								<span class="item-value">{{ selectedPlan.name }}</span>
							</div>

							@if (selectedPlan.type !== PluginSubscriptionType.FREE) {
								<div class="preview-item">
									<span class="item-label">Base Amount:</span>
									<span class="item-value">{{ formatPrice(preview.baseAmount, preview.currency) }}</span>
								</div>

								@if (preview.setupFee && preview.setupFee > 0) {
									<div class="preview-item">
										<span class="item-label">Setup Fee:</span>
										<span class="item-value">{{ formatPrice(preview.setupFee, preview.currency) }}</span>
									</div>
								}

								@if (preview.discount && preview.discount > 0) {
									<div class="preview-item discount">
										<span class="item-label">Discount:</span>
										<span class="item-value">-{{ formatPrice(preview.discount, preview.currency) }}</span>
									</div>
								}

								<div class="preview-item total">
									<span class="item-label">Total:</span>
									<span class="item-value">{{ formatPrice(preview.totalAmount, preview.currency) }}</span>
								</div>

								<div class="preview-item billing">
									<span class="item-label">Billing:</span>
									<span class="item-value">{{ formatBillingPeriod(preview.billingPeriod) }}</span>
								</div>
							} @else {
								<div class="preview-item total">
									<span class="item-label">Total:</span>
									<span class="item-value">Free</span>
								</div>
							}

							@if (preview.trialDays && preview.trialDays > 0) {
								<div class="preview-item trial">
									<span class="item-label">Trial Period:</span>
									<span class="item-value">{{ preview.trialDays }} days</span>
								</div>
							}
						</div>
					</div>
				}

				<!-- Terms and Conditions -->
				@if (selectedPlan && selectedPlan.type !== PluginSubscriptionType.FREE) {
					<div class="terms-section">
						<nb-checkbox formControlName="agreeToTerms">
							I agree to the
							<a href="#" target="_blank">Terms of Service</a>
							and
							<a href="#" target="_blank">Privacy Policy</a>
						</nb-checkbox>
					</div>
				}
			</form>
		}
	</nb-card-body>

	<nb-card-footer class="dialog-footer">
		<div class="footer-actions">
			<div class="left-actions">
				@if (canProceedWithoutSubscription) {
					<button
						nbButton
						status="basic"
						(click)="onSkipSubscription()"
						[disabled]="creating">
						Skip & Install Free
					</button>
				}
			</div>

			<div class="right-actions">
				<button
					nbButton
					status="basic"
					(click)="onCancel()"
					[disabled]="creating">
					Cancel
				</button>

				<button
					nbButton
					status="primary"
					(click)="onSubscribeAndInstall()"
					[disabled]="!subscriptionForm.valid || creating || !selectedPlan"
					*gauzySpinnerButton="creating">
					@if (selectedPlan?.type === PluginSubscriptionType.FREE) {
						Install Plugin
					} @else {
						Subscribe & Install
					}
				</button>
			</div>
		</div>
	</nb-card-footer>
</nb-card>
