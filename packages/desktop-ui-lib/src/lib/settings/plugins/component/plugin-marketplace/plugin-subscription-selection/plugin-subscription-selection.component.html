@let planViewModels = planViewModels$ | async; @let selectedPlanViewModel = selectedPlanViewModel$ | async; @let loading
= loading$ | async; @let error = error$ | async; @let creating = creating$ | async; @let updating = updating$ | async;
@let preview = subscriptionPreview$ | async; @let hasFreePlans = hasFreePlan$ | async; @let hasPaidPlans = hasPaidPlans$
| async; @let currentSubscription = currentSubscription$ | async; @let hasExistingSubscription =
hasExistingSubscription$ | async;

<nb-card class="subscription-selection-dialog">
	<!-- Keyboard Hints Overlay -->
	@if (showKeyboardHints) {
	<div class="keyboard-hints-overlay" (click)="showKeyboardHints = false">
		<div class="keyboard-hints-content" (click)="$event.stopPropagation()">
			<div class="hints-header">
				<h5>
					<nb-icon icon="flash-outline"></nb-icon>
					Keyboard Shortcuts
				</h5>
				<button nbButton ghost size="small" (click)="showKeyboardHints = false">
					<nb-icon icon="close-outline"></nb-icon>
				</button>
			</div>
			<div class="hints-list">
				<div class="hint-item">
					<kbd>Esc</kbd>
					<span>Close dialog</span>
				</div>
				<div class="hint-item">
					<kbd>Ctrl</kbd> + <kbd>Enter</kbd>
					<span>Submit form</span>
				</div>
				<div class="hint-item">
					<kbd>?</kbd>
					<span>Toggle this help</span>
				</div>
			</div>
		</div>
	</div>
	}

	<nb-card-header class="dialog-header">
		<div class="header-content">
			<div class="plugin-info">
				<nb-icon icon="puzzle-outline" class="plugin-icon"></nb-icon>
				<div class="plugin-details">
					<h4 class="plugin-name">{{ plugin?.name || 'Plugin' }}</h4>
					<p class="plugin-description">
						{{ plugin?.description || 'Choose a subscription plan to continue' }}
					</p>
				</div>
				<!-- Keyboard hint trigger -->
				<button
					nbButton
					ghost
					size="small"
					class="keyboard-hint-trigger"
					(click)="showKeyboardHints = true"
					nbTooltip="Keyboard shortcuts (?)"
					nbTooltipPlacement="bottom"
				>
					<nb-icon icon="flash-outline"></nb-icon>
				</button>
			</div>

			<!-- Current Subscription Alert -->
			@if (hasExistingSubscription && currentSubscription) {
			<nb-alert status="info" size="tiny" closable="false" class="current-subscription-alert">
				<nb-icon icon="shield-outline"></nb-icon>
				<span>
					You have an active
					<strong>{{ currentSubscription.subscriptionType | titlecase }}</strong> subscription.
					{{
						currentSubscription.subscriptionType === selectedPlanViewModel?.type
							? 'Select a different plan to upgrade or downgrade.'
							: 'Select a plan below to upgrade or downgrade.'
					}}
				</span>
			</nb-alert>
			}
		</div>
	</nb-card-header>

	<nb-card-body class="dialog-body">
		@if (loading) {
		<!-- Enhanced Skeleton Loader with descriptive message -->
		<div class="skeleton-loader">
			<div class="loading-message">
				<nb-icon icon="loader-outline" class="spinning"></nb-icon>
				<p>{{ getLoadingMessage() | async }}</p>
			</div>
			<div class="skeleton-header">
				<div class="skeleton-title"></div>
				<div class="skeleton-subtitle"></div>
			</div>
			<div class="skeleton-plans">
				@for (i of [1, 2, 3]; track i) {
				<div class="skeleton-plan-card">
					<div class="skeleton-card-header"></div>
					<div class="skeleton-card-price"></div>
					<div class="skeleton-card-features">
						<div class="skeleton-feature"></div>
						<div class="skeleton-feature"></div>
						<div class="skeleton-feature"></div>
					</div>
				</div>
				}
			</div>
		</div>
		} @else if (error && !creating) {
		<!-- Enhanced error display with contextual help -->
		<div class="error-state">
			<nb-alert status="danger" closable="false">
				<div class="error-content-expanded">
					<nb-icon icon="alert-triangle-outline" class="error-icon"></nb-icon>
					<div class="error-details">
						<h6 class="error-title">Failed to Load Subscription Plans</h6>
						<p class="error-message">{{ error }}</p>
						<div class="error-suggestions">
							<p><strong>Possible solutions:</strong></p>
							<ul>
								<li>Check your internet connection</li>
								<li>Try refreshing the page</li>
								<li>Contact support if the problem persists</li>
							</ul>
						</div>
					</div>
				</div>
			</nb-alert>
			<div class="error-actions">
				<button nbButton status="primary" (click)="loadSubscriptionPlans()">
					<nb-icon icon="refresh-outline"></nb-icon>
					Retry Loading Plans
				</button>
				<button nbButton status="basic" (click)="onCancel()">Cancel</button>
			</div>
		</div>
		} @else {
		<form [formGroup]="subscriptionForm" class="subscription-form">
			<!-- Subscription Creation Error -->
			@if (error && !loading) {
			<nb-alert status="danger" closable="false" class="subscription-error">
				<div class="error-content">
					<nb-icon icon="alert-triangle-outline"></nb-icon>
					<div class="error-message">
						<strong>Subscription Failed</strong>
						<p>{{ error }}</p>
					</div>
				</div>
				<div class="error-actions">
					<button nbButton status="danger" size="small" (click)="onResetSubscription()">
						<nb-icon icon="refresh-outline"></nb-icon>
						Try Again
					</button>
				</div>
			</nb-alert>
			}

			<!-- Subscription Plans -->
			<div class="plans-section">
				<div class="section-header">
					<h5 class="section-title">
						<nb-icon icon="credit-card-outline"></nb-icon>
						Choose Your Plan
					</h5>
					@if (planViewModels && planViewModels.length > 1) {
					<button
						nbButton
						size="small"
						status="basic"
						(click)="toggleComparisonView()"
						class="comparison-toggle"
					>
						<nb-icon [icon]="showComparisonView ? 'grid-outline' : 'list-outline'"></nb-icon>
						{{ showComparisonView ? 'Card View' : 'Compare Plans' }}
					</button>
					}
				</div>

				@if (planViewModels && planViewModels.length > 0) {
				<div class="plans-grid" [class.single-plan]="planViewModels.length === 1" [class.comparison-view]="showComparisonView">
					@for (planViewModel of planViewModels; track planViewModel.id) {
					<div class="plan-card-wrapper">
						<!-- Upgrade/Downgrade Badge -->
						@if (currentSubscription && currentSubscription.subscriptionType !== planViewModel.type) { @if
						(isPlanUpgrade(currentSubscription.subscriptionType, planViewModel.type)) {
						<div class="plan-action-badge upgrade-badge">
							<nb-icon icon="arrow-upward-outline"></nb-icon>
							<span>Upgrade</span>
						</div>
						} @else {
						<div class="plan-action-badge downgrade-badge">
							<nb-icon icon="arrow-downward-outline"></nb-icon>
							<span>Downgrade</span>
						</div>
						} }
						<!-- Yearly Savings Badge -->
						@if (planViewModel.billingPeriod === PluginBillingPeriod.YEARLY) {
							@let savings = calculateYearlySavings(planViewModel) | async;
							@if (savings && savings.percentage > 0) {
							<div class="savings-badge">
								<nb-icon icon="pricetags-outline"></nb-icon>
								<span>Save {{ savings.percentage }}%</span>
							</div>
							}
						}
						<lib-plan-card
							[plan]="planViewModel"
							[isSelected]="selectedPlanViewModel?.id === planViewModel.id"
							[isCurrentPlan]="
								currentSubscription && currentSubscription.subscriptionType === planViewModel.type
							"
							[isDisabled]="
								currentSubscription && currentSubscription.subscriptionType === planViewModel.type
							"
							[attr.role]="'button'"
							[attr.aria-label]="getPlanAriaLabel(planViewModel, currentSubscription)"
							[attr.tabindex]="0"
							(planSelected)="onPlanSelected($event)"
							class="plan-card-animated"
							[class.is-upgrade]="
								currentSubscription &&
								isPlanUpgrade(currentSubscription.subscriptionType, planViewModel.type)
							"
							[class.is-downgrade]="
								currentSubscription &&
								!isPlanUpgrade(currentSubscription.subscriptionType, planViewModel.type) &&
								currentSubscription.subscriptionType !== planViewModel.type
							"
						>
						</lib-plan-card>
					</div>
					}
				</div>
				} @else {
				<!-- Enhanced empty state -->
				<div class="empty-state">
					<nb-icon icon="pricetags-outline" class="empty-state-icon"></nb-icon>
					<h5 class="empty-state-title">No Subscription Plans Available</h5>
					<p class="empty-state-message">
						This plugin doesn't have any subscription plans configured yet. You may still be able to install
						it for free.
					</p>
					@if (canProceedWithoutSubscription$ | async) {
					<button nbButton status="primary" (click)="onSkipSubscription()">
						<nb-icon icon="download-outline"></nb-icon>
						Install Plugin
					</button>
					}
				</div>
				}
			</div>

			<!-- Billing Options (for paid plans) -->
			@if (selectedPlanViewModel && !selectedPlanViewModel.isFree) {
			<div class="billing-section">
				<h5 class="section-title">
					<nb-icon icon="calendar-outline"></nb-icon>
					Billing Options
					<nb-icon
						icon="question-mark-circle-outline"
						class="info-icon"
						nbTooltip="Choose how often you'd like to be billed. Annual billing often includes discounts."
						nbTooltipPlacement="top"
					></nb-icon>
				</h5>

				<div class="billing-period-selector">
					<nb-button-group>
						@for (period of [PluginBillingPeriod.MONTHLY, PluginBillingPeriod.YEARLY]; track period) {
						<button
							type="button"
							nbButton
							[status]="subscriptionForm.get('billingPeriod')?.value === period ? 'primary' : 'basic'"
							(click)="onBillingPeriodChange(period)"
							[attr.aria-label]="'Select ' + formatBillingPeriod(period) + ' billing'"
							class="billing-option-btn"
						>
							{{ formatBillingPeriod(period) }}
							@if (period === PluginBillingPeriod.YEARLY && selectedPlanViewModel) {
								@let savings = calculateYearlySavings(selectedPlanViewModel) | async;
								@if (savings && savings.percentage > 0) {
								<span class="billing-badge">Save {{ savings.percentage }}%</span>
								}
							}
						</button>
						}
					</nb-button-group>
				</div>

				<!-- Promo Code -->
				<div class="promo-code-section">
					<nb-form-field>
						<nb-icon nbPrefix icon="gift-outline"></nb-icon>
						<input
							nbInput
							type="text"
							placeholder="Enter promo code (optional)"
							formControlName="promoCode"
							[attr.aria-label]="'Promo code input'"
						/>
						<button
							nbSuffix
							nbButton
							ghost
							size="small"
							type="button"
							(click)="validatePromoCode()"
							[disabled]="!subscriptionForm.get('promoCode')?.value || validatingPromo"
							*gauzySpinnerButton="validatingPromo"
						>
							Apply
						</button>
					</nb-form-field>
					@if (promoCodeStatus) {
					<div
						class="promo-feedback"
						[class.success]="promoCodeStatus.valid"
						[class.error]="!promoCodeStatus.valid"
					>
						<nb-icon
							[icon]="promoCodeStatus.valid ? 'checkmark-circle-outline' : 'close-circle-outline'"
						></nb-icon>
						<span>{{ promoCodeStatus.message }}</span>
					</div>
					}
				</div>
			</div>
			}

			<!-- Subscription Preview -->
			<lib-subscription-preview [preview]="preview"></lib-subscription-preview>

			<!-- Terms and Conditions -->
			@if (selectedPlanViewModel) {
			<div class="terms-section">
				<nb-checkbox formControlName="agreeToTerms" [attr.aria-label]="'Agree to terms and conditions'">
					I agree to the
					<a href="#" target="_blank" rel="noopener noreferrer">Terms of Service</a>
					and
					<a href="#" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
				</nb-checkbox>
				@if (subscriptionForm.get('agreeToTerms')?.invalid && subscriptionForm.get('agreeToTerms')?.touched) {
				<div class="terms-error">
					<nb-icon icon="alert-circle-outline" status="danger"></nb-icon>
					<span>You must agree to the terms to continue</span>
				</div>
				}
			</div>
			}
		</form>
		}
	</nb-card-body>

	<nb-card-footer class="dialog-footer">
		<div class="footer-actions">
			<div class="left-actions">
				@if (canProceedWithoutSubscription$ | async) {
				<button nbButton status="basic" (click)="onSkipSubscription()" [disabled]="creating">
					Skip & Install Free
				</button>
				}
			</div>

			<div class="right-actions">
				<button nbButton status="basic" (click)="onCancel()" [disabled]="creating || updating">Cancel</button>

				@if (error && !loading) {
				<button nbButton status="warning" (click)="onResetSubscription()">
					<nb-icon icon="refresh-outline"></nb-icon>
					Reset & Try Again
				</button>
				} @if (currentSubscription && selectedPlanViewModel && currentSubscription.subscriptionType ===
				selectedPlanViewModel.type) {
				<!-- Current plan is selected - show disabled button -->
				<button nbButton status="success" [disabled]="true">
					<nb-icon icon="checkmark-circle-outline"></nb-icon>
					Current Plan
				</button>
				} @else if (hasExistingSubscription && selectedPlanViewModel) {
				<!-- User has subscription and selected a different plan - show upgrade/downgrade with tooltip -->
				<button
					nbButton
					[status]="
						isPlanUpgrade(currentSubscription!.subscriptionType, selectedPlanViewModel.type)
							? 'success'
							: 'warning'
					"
					(click)="onSubscribeAndInstall()"
					[disabled]="!subscriptionForm.valid || creating || updating || !selectedPlanViewModel || error"
					*gauzySpinnerButton="creating || updating"
					[nbTooltip]="
						isPlanUpgrade(currentSubscription!.subscriptionType, selectedPlanViewModel.type)
							? 'Upgrade to get instant access to new features'
							: 'Downgrade will take effect at the end of your current billing cycle'
					"
					nbTooltipPlacement="top"
				>
					<nb-icon
						[icon]="
							isPlanUpgrade(currentSubscription!.subscriptionType, selectedPlanViewModel.type)
								? 'arrow-upward-outline'
								: 'arrow-downward-outline'
						"
					></nb-icon>
					@if (isPlanUpgrade(currentSubscription!.subscriptionType, selectedPlanViewModel.type)) { Upgrade
					Plan } @else { Downgrade Plan }
				</button>
				} @else {
				<!-- No existing subscription - show normal subscribe button -->
				<button
					nbButton
					status="primary"
					(click)="onSubscribeAndInstall()"
					[disabled]="!subscriptionForm.valid || creating || updating || !selectedPlanViewModel || error"
					*gauzySpinnerButton="creating || updating"
				>
					@if (selectedPlanViewModel?.isFree) {
					<nb-icon icon="download-outline"></nb-icon>
					Install Plugin } @else {
					<nb-icon icon="shopping-cart-outline"></nb-icon>
					Subscribe & Install }
				</button>
				}
			</div>
		</div>
	</nb-card-footer>
</nb-card>
