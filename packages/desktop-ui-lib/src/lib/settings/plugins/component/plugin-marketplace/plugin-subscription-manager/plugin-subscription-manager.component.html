<!-- Installed and Installing Status -->
@let installed = installationQuery.installed$(plugin?.id) | async;
<!-- Loading State -->
@let installing = installationQuery.installing$(plugin?.id) |async;
<!-- Current Subscription -->
@let canChangePlan = !currentSubscription?.parentId;
<!-- Loading -->
@let isLoading = isLoading$ | async;
<!-- disabled State -->
@let disabled = installing || isLoading;
<!-- Current Plan -->
@let currentPlan = currentPlan$ | async;
<!-- Current Subscription -->
@let planViewModels = planViewModels$ | async;
<!-- Subscription Manager Container -->
<nb-card class="subscription-manager">
	<nb-card-header class="manager-header">
		<div class="header-content">
			<div class="title-group">
				<nb-icon icon="credit-card-outline" status="primary"></nb-icon>
				<h4 class="manager-title">Manage Subscription for {{ plugin?.name }}</h4>
			</div>
			<button
				nbButton
				ghost
				size="small"
				status="basic"
				class="close-btn"
				(click)="close()"
				aria-label="Close subscription manager"
			>
				<nb-icon icon="close-outline"></nb-icon>
			</button>
		</div>
	</nb-card-header>

	<nb-card-body class="manager-body">
		<!-- Current Subscription Status -->
		@if(currentSubscription) {
		<nb-card class="current-subscription">
			<nb-card-body
				class="subscription-card current"
				[class.trial]="currentSubscription && isInTrial(currentSubscription)"
				[class.expiring]="currentSubscription && isExpiringSoon(currentSubscription)"
			>
				<!-- Status Ribbon -->
				@if(currentSubscription && isInTrial(currentSubscription)) {
				<div class="status-ribbon trial">
					<nb-icon icon="clock-outline"></nb-icon>
					Trial Period
				</div>
				} @else if(currentSubscription && isExpiringSoon(currentSubscription)) {
				<div class="status-ribbon expiring">
					<nb-icon icon="alert-circle-outline"></nb-icon>
					Expiring Soon
				</div>
				}

				<div class="subscription-header">
					<div class="subscription-info">
						<div class="plan-badge-wrapper">
							<span class="plan-type-badge" [class]="currentPlan?.type">
								{{ currentPlan?.type | titlecase }}
							</span>
							@if(installed) {
							<span class="installed-badge">
								<nb-icon icon="checkmark-circle-2-outline"></nb-icon>
								Installed
							</span>
							}
						</div>
						<h5 class="plan-title">
							@if(isLoading) {
							<nb-spinner size="tiny"></nb-spinner>
							} @else if(currentPlan) {
							{{ currentPlan.name }}
							} @else { Current Plan }
						</h5>
						@if(currentPlan) { @if(currentPlan.description) {
						<p class="plan-description">{{ currentPlan.description }}</p>
						} }
						<div class="subscription-status-wrapper">
							<span class="subscription-status" [class]="currentSubscription.status">
								<nb-icon [icon]="getStatusIcon(currentSubscription.status)"></nb-icon>
								{{ currentSubscription.status | titlecase }}
							</span>
						</div>
					</div>

					<!-- Price Display -->
					@if(currentPlan?.price) {
					<div class="subscription-price">
						<span class="price-amount">
							{{ currentPlan.price | currency : currentPlan.currency }}
						</span>
						<span class="price-period"> / {{ currentPlan.billingPeriod | titlecase }} </span>
					</div>
					}
				</div>

				<!-- Subscription Details Grid -->
				<div class="subscription-details-grid">
					@if(currentSubscription.endDate) {
					<div class="detail-card">
						<div class="detail-icon">
							<nb-icon icon="calendar-outline"></nb-icon>
						</div>
						<div class="detail-content">
							<span class="detail-label">Next Billing</span>
							<span class="detail-value">{{ currentSubscription.endDate | date : 'mediumDate' }}</span>
						</div>
					</div>
					} @if(currentSubscription && isInTrial(currentSubscription) && currentSubscription.trialEndDate) {
					<div class="detail-card warning">
						<div class="detail-icon">
							<nb-icon icon="clock-outline"></nb-icon>
						</div>
						<div class="detail-content">
							<span class="detail-label">Trial Ends</span>
							<span class="detail-value">{{
								currentSubscription.trialEndDate | date : 'mediumDate'
							}}</span>
						</div>
					</div>
					} @if(currentSubscription && isExpiringSoon(currentSubscription) && currentSubscription.endDate) {
					<div class="detail-card danger">
						<div class="detail-icon">
							<nb-icon icon="alert-triangle-outline"></nb-icon>
						</div>
						<div class="detail-content">
							<span class="detail-label">Expires On</span>
							<span class="detail-value">{{ currentSubscription.endDate | date : 'mediumDate' }}</span>
						</div>
					</div>
					} @if(currentSubscription.startDate) {
					<div class="detail-card">
						<div class="detail-icon">
							<nb-icon icon="flag-outline"></nb-icon>
						</div>
						<div class="detail-content">
							<span class="detail-label">Started</span>
							<span class="detail-value">{{ currentSubscription.startDate | date : 'mediumDate' }}</span>
						</div>
					</div>
					}
				</div>

				<!-- Warning Banner for Plan Not Found -->
				@if(!(isLoading) && !(currentPlan) && currentSubscription.planId) {
				<div class="warning-banner">
					<nb-icon icon="alert-triangle-outline"></nb-icon>
					<span>Plan details not found (ID: {{ currentSubscription.planId }})</span>
				</div>
				}

				<!-- Action Buttons -->
				@if(currentSubscription.status !== 'cancelled') {
				<div class="subscription-actions">
					@if(!installed) {
					<button
						nbButton
						status="basic"
						size="small"
						class="action warning action-btn install-btn"
						[disabled]="disabled"
						(click)="install()"
					>
						<nb-icon *gauzySpinnerButton="installing" icon="cloud-download-outline" class="mr-1"></nb-icon>
						{{ 'BUTTONS.INSTALL' | translate }}
					</button>
					}
					<button
						nbButton
						outline
						status="danger"
						size="medium"
						class="action-btn cancel-btn"
						(click)="cancelSubscription()"
						[disabled]="disabled"
					>
						<nb-icon icon="close-circle-outline"></nb-icon>
						Cancel Subscription
					</button>
				</div>
				}
			</nb-card-body>
		</nb-card>
		}

		<!-- Available Plans -->
		@if(canChangePlan){
		<nb-card class="available-plans">
			<nb-card-header>
				<h5 class="plans-title">
					<nb-icon icon="layers-outline" status="info"></nb-icon>
					{{ currentSubscription ? 'Change Plan' : 'Choose a Plan' }}
				</h5>
			</nb-card-header>
			<nb-card-body>
				@if(planViewModels?.length) {
				<div class="plans-grid">
					@for(planViewModel of planViewModels; track planViewModel.id) {
					<lib-plan-card
						[plan]="planViewModel"
						[isSelected]="selectedPlanViewModel?.id === planViewModel.id"
						[isCurrentPlan]="isCurrentPlan(planViewModel.originalPlan)"
						[isDisabled]="isCurrentPlan(planViewModel.originalPlan)"
						[showSelection]="true"
						(planSelected)="onPlanSelected($event)"
					>
					</lib-plan-card>
					}
				</div>
				} @else {
				<div class="empty-plans-state" aria-live="polite">
					<nb-icon icon="cube-outline" status="basic"></nb-icon>
					<div class="empty-text">
						<p class="empty-title">No plans available right now</p>
						<p class="empty-subtitle">Check back soon or contact support for assistance.</p>
					</div>
				</div>
				}
			</nb-card-body>
		</nb-card>

		<!-- Billing Form -->
		@if(showBillingForm && selectedPlan) {
		<nb-card class="billing-form">
			<nb-card-header>
				<h5 class="billing-title">
					<nb-icon icon="credit-card-outline" status="success"></nb-icon>
					Billing Information
				</h5>
			</nb-card-header>
			<nb-card-body>
				<gauzy-subscription-billing-form
					[form]="subscriptionForm"
					[plan]="selectedPlan"
					[isLoading]="isLoading"
					[isUpgrade]="currentSubscription && canUpgrade(selectedPlan)"
					[isDowngrade]="currentSubscription && canDowngrade(selectedPlan)"
					(formSubmit)="subscribeToPlan()"
					(formCancel)="showBillingForm = false"
				>
				</gauzy-subscription-billing-form>
			</nb-card-body>
		</nb-card>
		} }
	</nb-card-body>
</nb-card>
