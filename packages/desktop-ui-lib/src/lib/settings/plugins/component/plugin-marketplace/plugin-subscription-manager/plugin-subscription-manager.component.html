<div class="subscription-manager">
	<div class="manager-header">
		<h4 class="manager-title">
			<nb-icon icon="credit-card-outline"></nb-icon>
			Manage Subscription for {{ plugin?.name }}
		</h4>
		<button nbButton ghost size="small" class="close-btn" (click)="close()">
			<nb-icon icon="close-outline"></nb-icon>
		</button>
	</div>

	<!-- Current Subscription Status -->
	<div class="current-subscription" *ngIf="currentSubscription">
		<div class="subscription-card current">
			<div class="subscription-header">
				<div class="subscription-info">
					<h5>Current Plan: {{ currentSubscription.subscriptionType | titlecase }}</h5>
					<p class="subscription-status" [class]="currentSubscription.status">
						<nb-icon [icon]="getStatusIcon(currentSubscription.status)"></nb-icon>
						{{ currentSubscription.status | titlecase }}
					</p>
				</div>
				<div class="subscription-actions">
					<button
						nbButton
						status="warning"
						size="small"
						(click)="cancelSubscription()"
						[disabled]="isLoading$ | async"
					>
						Cancel
					</button>
				</div>
			</div>

			<div class="subscription-details">
				<!-- Current Plan Details -->
				@if(isLoading$ | async) {
				<div class="detail-item plan-details loading">
					<span class="label">Plan:</span>
					<span class="value">
						<nb-spinner size="tiny"></nb-spinner>
						Loading plan details...
					</span>
				</div>
				} @else { @if(currentPlan$ | async; as currentPlan) {
				<div class="detail-item plan-details">
					<span class="label">Plan:</span>
					<span class="value">
						<strong>{{ currentPlan.name }}</strong>
						@if(currentPlan.description) {
						<small class="plan-description">{{ currentPlan.description }}</small>
						}
					</span>
				</div>
				} @else if(currentSubscription.planId) {
				<div class="detail-item plan-details warning">
					<span class="label">Plan:</span>
					<span class="value">
						<nb-icon icon="alert-triangle-outline"></nb-icon>
						Plan not found (ID: {{ currentSubscription.planId }})
					</span>
				</div>
				} }

				<div class="detail-item">
					<span class="label">Price:</span>
					<span class="value"
						>{{ currentSubscription.amount | currency : currentSubscription.currency }}/{{
							currentSubscription.billingPeriod
						}}</span
					>
				</div>
				<div class="detail-item" *ngIf="currentSubscription.nextBillingDate">
					<span class="label">Next Billing:</span>
					<span class="value">{{ currentSubscription.nextBillingDate | date : 'mediumDate' }}</span>
				</div>
				<div class="detail-item" *ngIf="currentSubscription.isInTrial">
					<span class="label">Trial Ends:</span>
					<span class="value warning">{{ currentSubscription.trialEndDate | date : 'mediumDate' }}</span>
				</div>
				<div class="detail-item" *ngIf="currentSubscription.isExpiringSoon">
					<span class="label">Expires:</span>
					<span class="value danger">{{ currentSubscription.endDate | date : 'mediumDate' }}</span>
				</div>

				<!-- Show plan features if available -->
				@if(!(isLoading$ | async)) { @if(currentPlan$ | async; as currentPlan) { @if(currentPlan.features &&
				currentPlan.features.length > 0) {
				<div class="detail-item features">
					<span class="label">Features:</span>
					<ul class="features-list-small">
						@for(feature of currentPlan.features.slice(0, 3); track feature) {
						<li>{{ feature }}</li>
						} @if(currentPlan.features.length > 3) {
						<li class="more-features">+{{ currentPlan.features.length - 3 }} more features</li>
						}
					</ul>
				</div>
				} } }
			</div>
		</div>
	</div>

	<!-- Available Plans -->
	<div class="available-plans">
		<h5 class="plans-title">
			{{ currentSubscription ? 'Change Plan' : 'Choose a Plan' }}
		</h5>

		<div class="plans-grid">
			@for(plan of (availablePlans$ | async); track plan.id) {
			<gauzy-subscription-plan-card
				[plan]="plan"
				[isSelected]="selectedPlan?.type === plan.type"
				[isCurrent]="isCurrentPlan(plan)"
				[isPopular]="plan.isPopular"
				[isRecommended]="plan.isRecommended"
				[canUpgrade]="canUpgrade(plan)"
				[canDowngrade]="canDowngrade(plan)"
				[priceLabel]="getPlanPrice(plan)"
				[savingsLabel]="getPlanSavings(plan)"
				[actionLabel]="
					isCurrentPlan(plan)
						? 'Current Plan'
						: canUpgrade(plan)
						? 'Upgrade to ' + plan.name
						: canDowngrade(plan)
						? 'Downgrade to ' + plan.name
						: 'Select ' + plan.name
				"
				[disabled]="isCurrentPlan(plan)"
				(planSelected)="selectPlan($event)"
				(actionClicked)="selectPlan($event)"
			>
			</gauzy-subscription-plan-card>
			}
		</div>
	</div>

	<!-- Billing Form -->
	<div class="billing-form" *ngIf="showBillingForm && selectedPlan">
		<gauzy-subscription-billing-form
			[form]="subscriptionForm"
			[plan]="selectedPlan"
			[isLoading]="isLoading$ | async"
			[isUpgrade]="currentSubscription && canUpgrade(selectedPlan)"
			[isDowngrade]="currentSubscription && canDowngrade(selectedPlan)"
			(formSubmit)="subscribeToPlan()"
			(formCancel)="showBillingForm = false"
		>
		</gauzy-subscription-billing-form>
	</div>
</div>
