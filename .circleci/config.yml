version: 2.1

orbs:
  node: circleci/node@7.2.1
  pulumi: pulumi/pulumi@2.1.0

# ==============================================================================
# Aliases - Reusable command definitions
# ==============================================================================

aliases:
  - &install-node
    name: Install Node with NPM using NVM
    command: |
      echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
      echo ' [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
      nvm install v24
      nvm alias default v24
      echo 'export NODE_OPTIONS=--max-old-space-size=12288' >> $BASH_ENV
      echo 'export NG_CLI_ANALYTICS=false' >> $BASH_ENV
      source $BASH_ENV
      nvm use v24
      node --version

  - &install-chrome
    name: Install Chrome
    command: |
      nvm use v24
      sudo apt install -y libappindicator3-1
      curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      sudo dpkg -i google-chrome.deb
      sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
      rm google-chrome.deb

  - &install-deps
    name: Install Global Dependencies
    command: |
      nvm use v24
      sudo rm -rf /etc/apt/sources.list.d/heroku.list
      sudo apt-get update
      sudo apt install -y npm build-essential unzip openjdk-17-jre python3-pip
      sudo apt install -y python3-distutils || true
      sudo apt install -y curl gnupg git libappindicator3-1 ca-certificates binutils icnsutils graphicsmagick
      python3 -m pip install --break-system-packages packaging setuptools || python3 -m pip install packaging setuptools
      sudo npm install --quiet node-gyp@10.2.0 -g
      sudo npm install --quiet ts-node@10.9.2 -g
      sudo npm config set python /usr/bin/python

  - &install-yarn
    name: Install Latest Yarn
    command: |
      nvm use v24
      # remove default yarn
      sudo rm -rf $(dirname $(which yarn))/yarn*
      # download latest
      rm -rf ~/.yarn
      curl -o- -L https://yarnpkg.com/install.sh | bash
      echo 'export PATH="${PATH}:${HOME}/.yarn/bin:${HOME}/.config/yarn/global/node_modules/.bin"' >> $BASH_ENV
      source $BASH_ENV

# ==============================================================================
# Defaults - Common job configuration
# ==============================================================================

defaults: &defaults
  working_directory: /tmp/workspace
  environment:
    # Increase memory for Node.js
    NODE_OPTIONS: --max-old-space-size=12288
    # Disable Angular CLI analytics
    NG_CLI_ANALYTICS: false

# ==============================================================================
# Jobs
# ==============================================================================

jobs:
  # ----------------------------------------------------------------------------
  # SonarQube/SonarCloud Code Quality Analysis
  # ----------------------------------------------------------------------------
  sonarqube:
    <<: *defaults
    machine:
      image: ubuntu-2204:current
    resource_class: large
    working_directory: /tmp/workspace/sonarqube-root
    description: Check Code Quality with SonarQube/SonarCloud
    steps:
      - checkout
      - run: *install-node
      - run: *install-deps
      - run: *install-yarn
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-sonarqube-{{ checksum "yarn.lock" }}
            - yarn-packages-sonarqube-
      - run:
          name: Verify Node version
          command: nvm use v24 && node --version
      - run:
          name: Install Yarn Dependencies
          command: nvm use v24 && yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts
          no_output_timeout: 60m
      - run:
          name: Run Postinstall Manually
          command: nvm use v24 && yarn postinstall.manual
      - run:
          name: Install SonarScanner CLI
          command: |
            SONAR_SCANNER_VERSION="8.0.1.6346"
            wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux-x64.zip
            unzip -q sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux-x64.zip
            mv sonar-scanner-${SONAR_SCANNER_VERSION}-linux-x64 sonar-scanner
      - run:
          name: Run SonarScanner
          command: |
            export SONAR_SCANNER_OPTS="-Xmx4096m"
            ./sonar-scanner/bin/sonar-scanner \
              -Dsonar.host.url=${SONAR_SERVER:-https://sonarcloud.io} \
              -Dsonar.token=${SONAR_TOKEN}
          no_output_timeout: 60m
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-sonarqube-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

  # ----------------------------------------------------------------------------
  # Build Monorepo Root (Bootstrap/Install verification)
  # ----------------------------------------------------------------------------
  build-monorepo-root:
    <<: *defaults
    machine:
      image: ubuntu-2204:current
    resource_class: large
    working_directory: /tmp/workspace/monorepo-root
    steps:
      - checkout
      - run: *install-node
      - run: *install-deps
      - run: *install-yarn
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-monorepo-{{ checksum "yarn.lock" }}
            - yarn-packages-monorepo-
      - run:
          name: Verify Node version
          command: nvm use v24 && node --version
      - run:
          name: Install Yarn Dependencies
          command: nvm use v24 && yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts
          no_output_timeout: 60m
      - run:
          name: Run Postinstall Manually
          command: nvm use v24 && yarn postinstall.manual
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-monorepo-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

  # ----------------------------------------------------------------------------
  # Build Desktop Application
  # ----------------------------------------------------------------------------
  build-desktop:
    <<: *defaults
    machine:
      image: ubuntu-2204:current
    resource_class: large
    working_directory: /tmp/workspace/desktop
    steps:
      - checkout
      - run: *install-node
      - run: *install-deps
      - run: *install-yarn
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-desktop-{{ checksum "yarn.lock" }}
            - yarn-packages-desktop-
      - run:
          name: Verify Node version
          command: nvm use v24 && node --version
      - run:
          name: Install Yarn Dependencies
          command: nvm use v24 && yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts
          no_output_timeout: 60m
      - run:
          name: Run Postinstall Manually
          command: nvm use v24 && yarn postinstall.manual
      - run:
          name: Run Build
          command: nvm use v24 && yarn build:desktop
          no_output_timeout: 60m
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-desktop-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

  # ----------------------------------------------------------------------------
  # Build API Application
  # ----------------------------------------------------------------------------
  build-api:
    <<: *defaults
    machine:
      image: ubuntu-2204:current
    resource_class: large
    working_directory: /tmp/workspace/api
    steps:
      - checkout
      - run: *install-node
      - run: *install-deps
      - run: *install-yarn
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-api-{{ checksum "yarn.lock" }}
            - yarn-packages-api-
      - run:
          name: Verify Node version
          command: nvm use v24 && node --version
      - run:
          name: Install Yarn Dependencies
          command: nvm use v24 && yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts
          no_output_timeout: 60m
      - run:
          name: Run Postinstall Manually
          command: nvm use v24 && yarn postinstall.manual
      - run:
          name: Run Packages Build
          command: nvm use v24 && yarn build:package:all
          no_output_timeout: 60m
      - run:
          name: Run Build
          command: nvm use v24 && yarn build:api:prod:ci
          no_output_timeout: 60m
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-api-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

  # ----------------------------------------------------------------------------
  # Build Web Application (Gauzy Frontend)
  # ----------------------------------------------------------------------------
  build-web:
    <<: *defaults
    machine:
      image: ubuntu-2204:current
    resource_class: large
    working_directory: /tmp/workspace/web
    steps:
      - checkout
      - run: *install-node
      - run: *install-deps
      - run: *install-yarn
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-web-{{ checksum "yarn.lock" }}
            - yarn-packages-web-
      - run:
          name: Verify Node version
          command: nvm use v24 && node --version
      - run:
          name: Install Yarn Dependencies
          command: nvm use v24 && yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts
          no_output_timeout: 60m
      - run:
          name: Run Postinstall Manually
          command: nvm use v24 && yarn postinstall.manual
      - run:
          name: Run Packages Build
          command: nvm use v24 && yarn build:package:all
          no_output_timeout: 60m
      - run:
          name: Run Build
          command: nvm use v24 && yarn build:gauzy:prod:ci
          no_output_timeout: 60m
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-web-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

  # ----------------------------------------------------------------------------
  # End-to-End Tests
  # ----------------------------------------------------------------------------
  test-e2e:
    <<: *defaults
    machine:
      image: ubuntu-2204:current
    resource_class: large
    working_directory: /tmp/workspace/test-e2e
    steps:
      - checkout
      - run: *install-node
      - run: *install-deps
      - run: *install-yarn
      - run: *install-chrome
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-e2e-{{ checksum "yarn.lock" }}
            - yarn-packages-e2e-
      - run:
          name: Verify Node version
          command: nvm use v24 && node --version
      - run:
          name: Install Yarn Dependencies
          command: nvm use v24 && yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts
          no_output_timeout: 60m
      - run:
          name: Run Postinstall Manually
          command: nvm use v24 && yarn postinstall.manual
      - run:
          name: Run API in background
          command: nvm use v24 && yarn start:api:ci
          background: true
      - run:
          name: Wait for API to be ready
          command: |
            echo "Waiting for API to start..."
            sleep 30
            # Add health check if available
            # curl --retry 10 --retry-delay 5 --retry-connrefused http://localhost:3000/api/health || true
      # Uncomment when e2e tests are ready
      # - run:
      #     name: Run e2e tests
      #     command: nvm use v24 && yarn run e2e:ci
      #     no_output_timeout: 120m
      # - store_test_results:
      #     path: apps/gauzy-e2e/test-results
      # - store_artifacts:
      #     path: apps/gauzy-e2e/screenshots
      #     destination: e2e-screenshots
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-e2e-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - run:
          name: Kill API Background Process
          command: pgrep node &> /dev/null && killall -w node || true
          when: always

  # ----------------------------------------------------------------------------
  # Pulumi Infrastructure Deployment
  # ----------------------------------------------------------------------------
  pulumi_deploy:
    <<: *defaults
    machine:
      image: ubuntu-2204:current
    resource_class: large
    working_directory: /tmp/workspace/pulumi
    steps:
      - checkout
      - run: *install-node
      - run: *install-deps
      - run: *install-yarn
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-pulumi-{{ checksum "yarn.lock" }}
            - yarn-packages-pulumi-
      - run:
          name: Verify Node version
          command: nvm use v24 && node --version
      - pulumi/login
      - run:
          name: Install NPM Packages
          command: |
            nvm use v24
            yarn install --ignore-scripts && yarn postinstall.manual
          no_output_timeout: 60m
      - pulumi/update:
          stack: dev
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-pulumi-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

# ==============================================================================
# Workflows
# ==============================================================================

workflows:
  version: 2

  # ----------------------------------------------------------------------------
  # Main Build Workflow - Runs on all branches
  # ----------------------------------------------------------------------------
  build:
    jobs:
      - build-monorepo-root
      - build-api:
          requires:
            - build-monorepo-root
      - build-web:
          requires:
            - build-monorepo-root
      - build-desktop:
          requires:
            - build-monorepo-root

  # ----------------------------------------------------------------------------
  # Test Workflow
  # ----------------------------------------------------------------------------
  test:
    jobs:
      - test-e2e:
          requires: []
          filters:
            branches:
              only:
                - develop
                - stage
                - main
                - master

  # ----------------------------------------------------------------------------
  # Code Quality Workflow - Runs on develop and main branches (DISABLED)
  # ----------------------------------------------------------------------------
  # code-quality:
  #   jobs:
  #     - sonarqube:
  #         filters:
  #           branches:
  #             only:
  #               - develop
  #               - stage
  #               - main
  #               - master

  # ----------------------------------------------------------------------------
  # Deployment Workflow (Manual trigger via API or scheduled)
  # ----------------------------------------------------------------------------
  # deploy:
  #   jobs:
  #     - pulumi_deploy:
  #         filters:
  #           branches:
  #             only:
  #               - main
